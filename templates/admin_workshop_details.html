<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Workshop Registration Details</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #121824 0%, #1a2436 50%, #121830 100%);
            color: #f0f4f8;
            margin: 0;
            padding: 24px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(20, 30, 48, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4d9eff 0%, #9c27b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: rgba(240, 244, 248, 0.7);
            margin: 0;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #a02622 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .logout-btn:active {
            transform: translateY(0);
        }

        /* Responsive header styling */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .action-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .logout-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                min-width: auto;
            }

            .header-title {
                font-size: 1.25rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: space-between;
            }

            .logout-btn {
                align-self: flex-end;
                max-width: 120px;
            }
        }

        h1 {
            color: #4d9eff;
            margin: 0;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #f0f4f8;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(40,50,70,0.8);
            color: #f0f4f8;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: 2px solid #4d9eff;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4d9eff, #357abd);
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #357abd, #2a5f99);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(30, 40, 58, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            font-size: 0.875rem;
            line-height: 1.4;
            margin-top: 24px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        thead {
            background: linear-gradient(135deg, rgba(77, 158, 255, 0.15) 0%, rgba(77, 158, 255, 0.08) 100%);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th, td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            vertical-align: middle;
            word-wrap: break-word;
            white-space: normal;
        }

        th {
            color: #4d9eff;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.8px;
            text-align: left;
            position: relative;
        }

        /* Specific column widths for better layout */
        th:nth-child(1), td:nth-child(1) { /* Name */
            min-width: 180px;
            max-width: 200px;
        }

        th:nth-child(2), td:nth-child(2) { /* Phone */
            min-width: 120px;
            max-width: 140px;
        }

        th:nth-child(3), td:nth-child(3) { /* Final Amount */
            min-width: 100px;
            max-width: 120px;
            text-align: right;
        }

        th:nth-child(4), td:nth-child(4) { /* Artist Name */
            min-width: 150px;
            max-width: 180px;
        }

        th:nth-child(5), td:nth-child(5) { /* Workshop Song */
            min-width: 140px;
            max-width: 160px;
        }

        th:nth-child(6), td:nth-child(6) { /* Workshop Date */
            min-width: 100px;
            max-width: 120px;
            text-align: center;
        }

        th:nth-child(7), td:nth-child(7) { /* Workshop Time */
            min-width: 120px;
            max-width: 140px;
            text-align: center;
        }

        /* Table body styling */
        tbody tr:nth-child(even) {
            background-color: rgba(30, 40, 58, 0.4);
        }

        tbody tr:nth-child(odd) {
            background-color: rgba(20, 30, 48, 0.3);
        }

        tbody tr:hover {
            background: linear-gradient(135deg, rgba(77, 158, 255, 0.08) 0%, rgba(77, 158, 255, 0.04) 100%);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Cell content styling */
        td {
            color: #f0f4f8;
            font-weight: 500;
        }

        /* Amount styling */
        td:nth-child(3) {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #10b981;
        }

        /* Date and time styling */
        td:nth-child(6), td:nth-child(7) {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.8rem;
            color: rgba(240, 244, 248, 0.9);
        }

        /* Artist name styling */
        td:nth-child(4) {
            font-weight: 600;
            color: #f59e0b;
        }

        /* Song name styling */
        td:nth-child(5) {
            font-style: italic;
            color: rgba(240, 244, 248, 0.95);
        }

        .loading, .error, .message {
            text-align: center;
            padding: 20px;
            font-size: 1rem;
        }

        .error {
            color: #ff6b6b;
        }

        .message {
            color: #5cb85c;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(40,50,70,0.8);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1;
            min-width: 150px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4d9eff;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }

        /* Responsive table styles */
        @media (max-width: 1200px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group select,
            .filter-group input {
                width: 100%;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .stats {
                flex-direction: column;
            }

            table, thead, tbody, th, td, tr {
                display: block;
                width: 100% !important;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                margin-bottom: 15px;
                padding: 10px;
                background: rgba(25,35,50,0.9) !important;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }

            td {
                border: none;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                position: relative;
                padding-left: 45% !important;
                padding-top: 8px;
                padding-bottom: 8px;
                white-space: normal;
                text-align: right !important;
                min-height: 28px;
            }

            td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(45% - 20px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left !important;
                font-weight: 600;
                color: #4d9eff;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                text-align: center;
            }
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4d9eff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: rgba(30, 40, 58, 0.95);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 class="header-title">Workshop Registration Details</h1>
                <p class="header-subtitle">View and manage workshop participant registrations</p>
            </div>
            <div class="header-actions">
                <div class="action-buttons">
                    <button id="refresh-btn" class="btn btn-secondary">
                        <span class="loading-spinner" id="refresh-spinner" style="display: none;"></span>
                        Refresh
                    </button>
                    <button id="export-csv-btn" class="btn btn-success">
                        <span class="loading-spinner" id="export-spinner" style="display: none;"></span>
                        Export CSV
                    </button>
                </div>
                <button id="logout-btn" class="logout-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Logout
                </button>
            </div>
        </div>

        <div class="stats" id="stats-container">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="artist-filter">Filter by Artist:</label>
                <select id="artist-filter">
                    <option value="">All Artists</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="song-filter">Filter by Song:</label>
                <select id="song-filter">
                    <option value="">All Songs</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="search-input">Search by Name/Phone:</label>
                <input type="text" id="search-input" placeholder="Enter name or phone number...">
            </div>

            <div class="filter-group">
                <label>&nbsp;</label>
                <div class="action-buttons">
                    <button id="apply-filters-btn" class="btn btn-primary">Apply Filters</button>
                    <button id="clear-filters-btn" class="btn btn-secondary">Clear</button>
                </div>
            </div>
        </div>

        <div id="message-area"></div>

        <table id="registrations-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Final Amount</th>
                    <th>Artist Name</th>
                    <th>Workshop Song</th>
                    <th>Workshop Date</th>
                    <th>Workshop Time</th>
                </tr>
            </thead>
            <tbody>
                <tr class="loading-row">
                    <td colspan="7" class="loading">
                        <span class="loading-spinner"></span>
                        Loading workshop registrations...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Login Required Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <div style="text-align: center;">
                <div class="logo" style="margin: 0 auto 20px;">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h2 style="color: #4d9eff; margin-bottom: 16px;">Admin Access Required</h2>
                <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">You need to be logged in as an admin to access the workshop registration details.</p>
                <a href="/admin/login" class="btn" style="display: inline-block; width: auto; padding: 12px 24px; text-decoration: none;">Go to Admin Login</a>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let artists = new Set();
        let songs = new Set();
        let isLoading = false; // Flag to prevent multiple simultaneous API calls
        let isAuthenticating = false; // Flag to prevent multiple simultaneous auth checks

        // Check authentication on page load
        async function checkAuth() {
            // Prevent multiple simultaneous auth checks
            if (isAuthenticating) {
                return false;
            }

            isAuthenticating = true;

            const token = getAuthToken();
            if (!token) {
                // No token found, show login modal immediately
                showLoginModal();
                isAuthenticating = false;
                return false;
            }

            try {
                const response = await fetch('/admin/api/workshop-registrations', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    showLoginModal();
                    isAuthenticating = false;
                    return false;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                isAuthenticating = false;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginModal();
                isAuthenticating = false;
                return false;
            }
        }

        function getAuthToken() {
            // Try to get token from localStorage, sessionStorage, or cookies
            return localStorage.getItem('admin_token') ||
                   sessionStorage.getItem('admin_token') ||
                   getCookie('admin_token');
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'block';
        }

        // Fetch workshop registration data
        async function fetchRegistrations() {
            // Prevent multiple simultaneous API calls
            if (isLoading) {
                return;
            }

            isLoading = true;

            try {
                const response = await fetch('/admin/api/workshop-registrations', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    showLoginModal();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                allData = data.registrations || [];
                updateFilters();
                updateStats();
                renderTable(allData);
            } catch (error) {
                console.error('Error fetching registrations:', error);
                showMessage('Failed to load workshop registrations. Please try again.', 'error');
                renderTable([]);
            } finally {
                isLoading = false;
            }
        }

        // Update filter options
        function updateFilters() {
            artists.clear();
            songs.clear();

            allData.forEach(registration => {
                if (registration.artist_name) artists.add(registration.artist_name);
                if (registration.workshop_song) songs.add(registration.workshop_song);
            });

            updateArtistFilter();
            updateSongFilter();
        }

        function updateArtistFilter() {
            const artistFilter = document.getElementById('artist-filter');
            const currentValue = artistFilter.value;

            artistFilter.innerHTML = '<option value="">All Artists</option>';
            Array.from(artists).sort().forEach(artist => {
                const option = document.createElement('option');
                option.value = artist;
                option.textContent = artist;
                artistFilter.appendChild(option);
            });

            artistFilter.value = currentValue;
        }

        function updateSongFilter() {
            const songFilter = document.getElementById('song-filter');
            const currentValue = songFilter.value;

            songFilter.innerHTML = '<option value="">All Songs</option>';
            Array.from(songs).sort().forEach(song => {
                const option = document.createElement('option');
                option.value = song;
                option.textContent = song;
                songFilter.appendChild(option);
            });

            songFilter.value = currentValue;
        }

        // Update statistics
        function updateStats() {
            const totalRegistrations = allData.length;
            const totalRevenue = allData.reduce((sum, reg) => sum + (reg.final_amount || 0), 0);
            const uniqueUsers = new Set(allData.map(reg => reg.phone)).size;
            const uniqueWorkshops = new Set(allData.map(reg => `${reg.artist_name}-${reg.workshop_song}-${reg.workshop_date}`)).size;

            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalRegistrations}</div>
                    <div class="stat-label">Total Registrations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">₹${totalRevenue.toLocaleString()}</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueUsers}</div>
                    <div class="stat-label">Unique Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueWorkshops}</div>
                    <div class="stat-label">Workshops</div>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            const artistFilter = document.getElementById('artist-filter').value;
            const songFilter = document.getElementById('song-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            filteredData = allData.filter(registration => {
                const matchesArtist = !artistFilter || registration.artist_name === artistFilter;
                const matchesSong = !songFilter || registration.workshop_song === songFilter;
                const matchesSearch = !searchTerm ||
                    (registration.name && registration.name.toLowerCase().includes(searchTerm)) ||
                    (registration.phone && registration.phone.includes(searchTerm));

                return matchesArtist && matchesSong && matchesSearch;
            });

            renderTable(filteredData);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('artist-filter').value = '';
            document.getElementById('song-filter').value = '';
            document.getElementById('search-input').value = '';
            filteredData = [...allData];
            renderTable(filteredData);
        }

        // Render table
        function renderTable(data) {
            const tableBody = document.querySelector("#registrations-table tbody");

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="message">No registrations found matching the current filters.</td></tr>';
            return;
        }

            tableBody.innerHTML = '';

            data.forEach(registration => {
                const row = tableBody.insertRow();

                // Add data-label for responsive mode
                row.insertCell().outerHTML = `<td data-label="Name">${registration.name || 'N/A'}</td>`;
                row.insertCell().outerHTML = `<td data-label="Phone">${registration.phone || 'N/A'}</td>`;
                row.insertCell().outerHTML = `<td data-label="Final Amount">₹${(registration.final_amount || 0).toLocaleString()}</td>`;
                row.insertCell().outerHTML = `<td data-label="Artist Name">${registration.artist_name || 'N/A'}</td>`;
                row.insertCell().outerHTML = `<td data-label="Workshop Song">${registration.workshop_song || 'N/A'}</td>`;
                row.insertCell().outerHTML = `<td data-label="Workshop Date">${registration.workshop_date || 'N/A'}</td>`;
                row.insertCell().outerHTML = `<td data-label="Workshop Time">${registration.workshop_time || 'N/A'}</td>`;
            });
        }

        // Export CSV
        async function exportCSV() {
            const exportBtn = document.getElementById('export-csv-btn');
            const exportSpinner = document.getElementById('export-spinner');

            exportBtn.disabled = true;
            exportSpinner.style.display = 'inline-block';

            try {
                const dataToExport = filteredData.length > 0 ? filteredData : allData;

                if (dataToExport.length === 0) {
                    showMessage('No data to export.', 'error');
                    return;
                }

                // Create CSV content
                const headers = ['Name', 'Phone', 'Final Amount', 'Artist Name', 'Workshop Song', 'Workshop Date', 'Workshop Time'];
                const csvContent = [
                    headers.join(','),
                    ...dataToExport.map(row => [
                        `"${row.name || ''}"`,
                        `"${row.phone || ''}"`,
                        `"${row.final_amount || 0}"`,
                        `"${row.artist_name || ''}"`,
                        `"${row.workshop_song || ''}"`,
                        `"${row.workshop_date || ''}"`,
                        `"${row.workshop_time || ''}"`
                    ].join(','))
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `workshop_registrations_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`Successfully exported ${dataToExport.length} registrations to CSV.`, 'message');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                showMessage('Failed to export CSV. Please try again.', 'error');
            } finally {
                exportBtn.disabled = false;
                exportSpinner.style.display = 'none';
            }
        }

        // Show message
        function showMessage(message, type = "message") {
            const messageArea = document.getElementById("message-area");
            messageArea.innerHTML = `<p class="${type}">${message}</p>`;
            setTimeout(() => {
                messageArea.innerHTML = "";
            }, 5000);
        }

        // Show loading state initially
        function showLoadingState() {
            const container = document.querySelector('.container');
            if (container) {
                // Store original content for restoration
                if (!container.dataset.originalContent) {
                    container.dataset.originalContent = container.innerHTML;
                }
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                        <h2 style="color: #4d9eff; margin-bottom: 16px;">Loading Admin Panel</h2>
                        <p style="color: rgba(255,255,255,0.7);">Please wait while we verify your access...</p>
                    </div>
                `;
            }
        }

        // Handle logout functionality
        function handleLogout() {
            // Show confirmation dialog
            const confirmed = confirm('Are you sure you want to logout?');
            if (!confirmed) return;

            try {
                // Clear authentication tokens
                localStorage.removeItem('admin_token');
                sessionStorage.removeItem('admin_token');

                // Clear any cookies (if set)
                document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

                // Show success message
                showMessage('Logged out successfully. Redirecting...', 'message');

                // Redirect to login page after a short delay
                setTimeout(() => {
                    window.location.href = '/admin/login';
                }, 1500);

            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Error during logout. Please try again.', 'error');
            }
        }

        // Bind all event listeners
        function bindEventListeners() {
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    if (isLoading) return; // Prevent multiple clicks
                    const refreshSpinner = document.getElementById('refresh-spinner');
                    if (refreshSpinner) refreshSpinner.style.display = 'inline-block';
                    await fetchRegistrations();
                    if (refreshSpinner) refreshSpinner.style.display = 'none';
                });
            }

            // Apply filters button
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }

            // Clear filters button
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearFilters);
            }

            // Export CSV button
            const exportCsvBtn = document.getElementById('export-csv-btn');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', exportCSV);
            }

            // Filter dropdowns
            const artistFilter = document.getElementById('artist-filter');
            if (artistFilter) {
                artistFilter.addEventListener('change', applyFilters);
            }

            const songFilter = document.getElementById('song-filter');
            if (songFilter) {
                songFilter.addEventListener('change', applyFilters);
            }

            // Search input
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        applyFilters();
                    }
                });
            }

            // Modal close
            const closeModalBtn = document.getElementById('close-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    document.getElementById('login-modal').style.display = 'none';
                });
            }

            // Modal background click
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            // Logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        // Restore original page content
        function restorePageContent() {
            const container = document.querySelector('.container');
            if (container && container.dataset.originalContent) {
                container.innerHTML = container.dataset.originalContent;
                // Re-bind event listeners after restoring content
                bindEventListeners();
            }
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", async () => {
            // Only show loading state if we don't have a token
            const token = getAuthToken();
            if (!token) {
                showLoginModal();
                return;
            }

            showLoadingState();

            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                // Restore the page content and load admin data
                restorePageContent();
                await fetchRegistrations();
            }
            // If not authenticated, the modal will be shown by checkAuth()
        });

        // Initial binding of event listeners
        bindEventListeners();
    </script>
</body>
</html>

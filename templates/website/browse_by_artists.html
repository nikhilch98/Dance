<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Browse dance workshops by artists" />
  <title>Browse by Artists</title>

  <!-- Enhanced Critical CSS -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --primary-color: #007bff;
      --accent-color: #0056b3;
      --secondary-color: #6c757d;
      --background-color: #f0f4f8;
      --card-background: #fff;
      --text-color: #212529;
      --shadow-color: rgba(0, 0, 0, 0.12);
      --instagram-color: #C13584;
      --transition-speed: 0.3s;
      --border-radius: 12px;
      --spacing-unit: 24px;
    }

    /* Base styles and typography */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: var(--spacing-unit);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-weight: 600;
      font-size: 2.25rem;
      color: var(--primary-color);
      margin-bottom: var(--spacing-unit);
      text-align: center;
      text-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .nav-back {
      display: inline-block;
      margin-bottom: var(--spacing-unit);
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      transition: color var(--transition-speed);
    }

    .nav-back:hover,
    .nav-back:focus-visible {
      color: var(--accent-color);
      text-decoration: underline;
      outline: none;
    }

    .artist-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: var(--spacing-unit);
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 0 var(--spacing-unit);
    }

    /* Artist Card */
    .artist-card {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 16px var(--shadow-color);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      user-select: none;
      padding-bottom: 1.5em;
      will-change: transform;
    }

    .artist-card:hover,
    .artist-card:focus-visible {
      transform: translateY(-6px) scale(1.04);
      box-shadow: 0 16px 36px rgba(0,123,255,0.3);
      outline: none;
      z-index: 4;
    }

    .artist-card:focus-visible {
      outline: 3px solid var(--accent-color);
      outline-offset: 4px;
      z-index: 5;
    }

    .artist-card img {
      width: 100%;
      aspect-ratio: 3 / 4;
      object-fit: cover;
      background: var(--secondary-color);
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
      box-shadow: inset 0 -10px 20px -10px rgba(0,0,0,0.25);
      pointer-events: none;
      transition: transform var(--transition-speed);
    }

    .artist-card h3 {
      margin: 12px 10px 0 10px;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .instagram-link {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition-speed);
      z-index: 5;
    }

    .instagram-link:hover,
    .instagram-link:focus-visible {
      background: rgba(0, 0, 0, 0.85);
      outline: none;
    }

    .instagram-link img {
      width: 24px !important;
      height: 24px !important;
      margin: 0 !important;
      user-select: none;
      pointer-events: none;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: var(--spacing-unit) 0;
    }

    .modal-content {
      background: var(--card-background);
      padding: var(--spacing-unit);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color var(--transition-speed);
    }

    .close-btn:hover,
    .close-btn:focus-visible {
      background: #a71d2a;
      outline: none;
    }

    .workshop-item {
      background: var(--background-color);
      padding: 16px;
      margin: 12px 0;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 8px var(--shadow-color);
      font-size: 1rem;
    }

    .workshop-item p {
      margin: 6px 0;
    }

    .register-link {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 700;
      transition: background-color var(--transition-speed);
    }

    .register-link:hover,
    .register-link:focus-visible {
      background: var(--accent-color);
      outline: none;
    }

    /* Loading and Error */
    .loading,
    .error {
      text-align: center;
      padding: var(--spacing-unit);
      font-size: 1.1rem;
    }

    .error {
      color: #dc3545;
    }

    /* Accessibility */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0,0,0,0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      h1 {
        font-size: 1.75rem;
        margin-bottom: 16px;
      }

      .nav-back {
        font-size: 1.1rem;
        padding: 10px 0;
        display: inline-block;
      }

      .artist-container {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
        padding: 0 12px;
      }

      .artist-card h3 {
        font-size: 1.1rem;
        margin: 10px 8px 0 8px;
      }

      .workshop-item {
        padding: 12px;
        margin: 10px 0;
        font-size: 0.9rem;
      }

      .register-link {
        display: block;
        text-align: center;
        padding: 12px;
        margin-top: 10px;
        font-size: 1rem;
      }

      .modal-content {
        width: 95%;
        margin: 10px;
        padding: 20px;
        max-height: 90vh;
      }

      .close-btn {
        padding: 8px 14px;
        font-size: 1.2rem;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) {
      .artist-card:hover,
      .artist-card:focus-visible {
        transform: none;
        box-shadow: 0 8px 12px var(--shadow-color);
        outline: none;
      }

      .artist-card:active {
        transform: scale(0.98);
      }

      .register-link {
        -webkit-tap-highlight-color: transparent;
      }

      .register-link:active {
        background: var(--accent-color);
      }
    }

    /* Print styles */
    @media print {
      .artist-card {
        break-inside: avoid;
        box-shadow: none;
      }

      .modal {
        position: static;
        display: block;
        background: none;
      }

      .close-btn {
        display: none;
      }
    }
  </style>

  <script>
    // State management
    const state = {
      artists: [],
      loading: false,
      error: null
    };

    // Fetch artists from the API
    async function fetchArtists() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      try {
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';

        const response = await fetch("/api/artists?version=v2");
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        state.artists = await response.json();
        populateArtists(state.artists);
      } catch (error) {
        console.error("Error fetching artists:", error);
        errorEl.textContent = "Failed to load artists. Please try again later.";
        errorEl.style.display = 'block';
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // Populate artists into the container
    function populateArtists(artists) {
      const container = document.getElementById("artist-container");
      const defaultImage = 'data:image/svg+xml,%3Csvg width="300" height="400" xmlns="http://www.w3.org/2000/svg"%3E%3Crect width="100%" height="100%" fill="%23007bff"/%3E%3Ctext x="50%" y="50%" font-family="Arial" font-size="24" fill="white" text-anchor="middle" dominant-baseline="middle"%3EDance Artist%3C/text%3E%3C/svg%3E';

      container.innerHTML = ""; // Clear existing content
      artists.forEach(artist => {
        const card = document.createElement("div");
        card.className = "artist-card";
        card.setAttribute("data-artist-id", artist.id);
        card.setAttribute("data-artist-name", artist.name);
        card.tabIndex = 0;
        card.innerHTML = `
          <img src="${artist.image_url ? `/proxy-image/?url=${encodeURIComponent(artist.image_url)}` : defaultImage}"
               alt="${artist.name}" loading="lazy"
               onerror="this.src='${defaultImage}'" />
          <h3>${artist.name}</h3>
          <a href="${artist.instagram_link}"
             target="_blank"
             rel="noopener noreferrer"
             class="instagram-link"
             onclick="event.stopPropagation()"
             aria-label="Instagram profile of ${artist.name}">
             <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='white' d='M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.897 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.897-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z'/%3E%3C/svg%3E" />
          </a>
        `;
        card.addEventListener("click", () => openModal(artist.id, artist.name));
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            openModal(artist.id, artist.name);
          }
        });
        container.appendChild(card);
      });
    }

    // Open Modal and Fetch Workshops
    async function openModal(artistId, artistName) {
      const workshopsList = document.getElementById("workshops-list");
      document.getElementById("artist-name").innerText = artistName;
      document.getElementById("artist-modal").style.display = "flex";
      workshopsList.innerHTML = '<div class="loading">Loading workshops...</div>';

      try {
        const response = await fetch(`/api/workshops_by_artist/${artistId}?version=v2`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const workshops = await response.json();
        displayWorkshops(workshops);
      } catch (error) {
        console.error("Error fetching workshops:", error);
        workshopsList.innerHTML = '<div class="error">Failed to load workshops. Please try again later.</div>';
      }
    }

    // Display Workshops
    function displayWorkshops(workshops) {
      const list = document.getElementById("workshops-list");

      if (!workshops.length) {
        list.innerHTML = "<p>No upcoming workshops found.</p>";
        return;
      }

      list.innerHTML = workshops.map(workshop => `
        <div class="workshop-item">
          <p><strong>${workshop.date}</strong> - ${workshop.time}</p>
          <p>Song: ${workshop.song || 'Not specified'}</p>
          <p>Studio: ${workshop.studio_id}</p>
          <p>Pricing: ${workshop.pricing_info || 'Contact studio'}</p>
          <p><a href="${workshop.payment_link}" target="_blank" class="register-link" rel="noopener">Register</a></p>
        </div>
      `).join('');
    }

    // Close Modal
    function closeModal() {
      document.getElementById("artist-modal").style.display = "none";
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Close modal when clicking outside modal content
      document.getElementById("artist-modal").addEventListener("click", function(event) {
        if (event.target === this) {
          closeModal();
        }
      });

      // Close modal on escape key
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeModal();
        }
      });

      fetchArtists();
    });
  </script>
</head>
<body>
  <a href="/" class="nav-back">← Back to Categories</a>
  <h1>Artists</h1>

  <div id="loading" class="loading" style="display:none">Loading artists...</div>
  <div id="error" class="error" style="display:none"></div>

  <div class="artist-container" id="artist-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal -->
  <div class="modal" id="artist-modal" role="dialog" aria-labelledby="artist-name" aria-modal="true" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()" aria-label="Close modal">×</button>
      <h2 id="artist-name"></h2>
      <div id="workshops-list"></div>
    </div>
  </div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Status - Nachna</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-tertiary: rgba(255, 255, 255, 0.6);
            --background-primary: #0A0A0F;
            --background-secondary: rgba(255, 255, 255, 0.08);
            --success-color: #10B981;
            --error-color: #EF4444;
            --warning-color: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .order-card {
            background: var(--background-secondary);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .order-info h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .order-id {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.created {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }

        .order-status.paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .order-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .order-status.expired {
            background: rgba(156, 163, 175, 0.2);
            color: #9CA3AF;
        }

        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .bundle-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .bundle-info-title {
            color: #00D4FF;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .bundle-info-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .qr-section {
            margin-top: 2rem;
        }

        .qr-loading, .qr-error {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .qr-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .qr-title {
            color: #00D4FF;
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
        }

        .qr-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 8px;
            background: white;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
        }

        .qr-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.danger {
            background: var(--error-color);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00D4FF;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .refresh-section {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .actions-section {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .order-details {
                grid-template-columns: 1fr;
            }

            .order-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .actions-section {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Nachna</div>
            <div class="subtitle">Order Status & QR Code</div>
        </div>

        <div class="refresh-section">
            <button class="btn" onclick="refreshOrderStatus()">
                <div class="loading-spinner" id="refresh-spinner" style="display: none;"></div>
                <span id="refresh-text">Refresh Status</span>
            </button>
        </div>

        <div id="order-content">
            <!-- Order content will be loaded here -->
        </div>

        <div class="actions-section">
            <a href="/studio" class="btn secondary">‚Üê Back to Studio</a>
            <button class="btn" onclick="window.print()">üìÑ Print Order</button>
        </div>
    </div>

    <script>
        let currentOrderId = null;
        let refreshInterval = null;
        let qrGenerationAttempts = 0;
        let maxQrGenerationAttempts = 10; // Maximum number of auto-refresh attempts

        // Get order ID from URL parameters
        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('order_id');
        }

        // Load order status
        async function loadOrderStatus(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }

                const data = await response.json();
                if (data.success) {
                    displayOrderStatus(data.order);
                } else {
                    throw new Error('Failed to load order');
                }
            } catch (error) {
                console.error('Error loading order:', error);
                displayError(error.message);
            }
        }

        // Display order status
        function displayOrderStatus(order) {
            const orderContent = document.getElementById('order-content');

            // Handle both single workshop and bundle orders
            const workshopUuids = order.workshop_uuids || [];
            const isBundle = order.is_bundle_order;

            // Improved QR codes detection logic
            const hasQrCodes = order.qr_codes_data &&
                              typeof order.qr_codes_data === 'object' &&
                              Object.keys(order.qr_codes_data).length > 0 &&
                              Object.values(order.qr_codes_data).some(qrData => qrData && qrData.length > 0);

            // Debug logging for QR codes detection
            console.log('QR Codes Debug:', {
                hasQrCodes,
                qr_codes_data: order.qr_codes_data,
                qr_codes_keys: order.qr_codes_data ? Object.keys(order.qr_codes_data) : 'null',
                order_status: order.status,
                workshop_uuids: workshopUuids,
                qr_generation_attempts: qrGenerationAttempts
            });

            // Reset QR generation attempts if QR codes are found
            if (hasQrCodes) {
                qrGenerationAttempts = 0;
                console.log('QR codes found, resetting attempt counter');
            }

            // Get workshop titles for bundle
            const workshopTitles = {};
            if (isBundle && order.bundle_info && order.bundle_info.workshops) {
                order.bundle_info.workshops.forEach(workshop => {
                    workshopTitles[workshop.uuid] = workshop.song || workshop.title || 'Workshop';
                });
            }

            orderContent.innerHTML = `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <h2>${order.workshop_details.title}</h2>
                            <div class="order-id">Order: ${order.order_id}</div>
                        </div>
                        <div class="order-status ${order.status.toLowerCase()}">${getStatusText(order.status)}</div>
                    </div>

                    ${isBundle && order.bundle_info ? `
                    <div class="bundle-info">
                        <div class="bundle-info-title">Bundle: ${order.bundle_info.name}</div>
                        <div class="bundle-info-text">${order.bundle_info.description}</div>
                        <div class="bundle-info-text">${order.bundle_total_workshops} workshops included</div>
                        ${order.bundle_info.savings_amount > 0 ? `<div class="bundle-info-text" style="color: #10B981; font-weight: 600;">You saved ‚Çπ${order.bundle_info.savings_amount.toFixed(2)}!</div>` : ''}
                    </div>
                    ` : ''}

                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">Workshop</div>
                            <div class="detail-value">${order.workshop_details.title}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Studio</div>
                            <div class="detail-value">${order.workshop_details.studio_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date & Time</div>
                            <div class="detail-value">${order.workshop_details.date} ‚Ä¢ ${order.workshop_details.time}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Amount</div>
                            <div class="detail-value">‚Çπ${(order.amount / 100).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${getStatusText(order.status)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Order Date</div>
                            <div class="detail-value">${new Date(order.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>

                    ${hasQrCodes ? `
                    <div class="qr-section">
                        <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-primary);">Registration QR Code${Object.keys(order.qr_codes_data).length > 1 ? 's' : ''}</h3>
                        <div class="qr-container">
                            ${Object.entries(order.qr_codes_data).map(([workshopUuid, qrCodeData]) => {
                                const workshopTitle = workshopTitles[workshopUuid] || `Workshop ${Object.keys(order.qr_codes_data).indexOf(workshopUuid) + 1}`;
                                return `
                                    <div class="qr-card">
                                        <div class="qr-title">${workshopTitle}</div>
                                        <img class="qr-image" src="data:image/png;base64,${qrCodeData}" alt="QR Code for ${workshopTitle}" />
                                        <div class="qr-actions">
                                            <button class="btn secondary" onclick="downloadQR('${qrCodeData}', '${workshopTitle}')">üì• Download</button>
                                            <button class="btn secondary" onclick="shareQR('${qrCodeData}', '${workshopTitle}')">üì§ Share</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : order.status === 'paid' ? `
                    <div class="qr-section" id="qr-loading-section">
                        <div class="qr-loading">
                            <div class="loading-spinner" id="qr-loading-spinner"></div>
                            <p id="qr-loading-text">Generating QR code...</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn" onclick="refreshOrderStatus()">Refresh to Load QR</button>
                                <button class="btn secondary" onclick="triggerQRGeneration()" style="margin-left: 0.5rem;">Generate QR Now</button>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">If QR codes don't appear, try refreshing or contact support.</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Display error message
        function displayError(message) {
            const orderContent = document.getElementById('order-content');
            orderContent.innerHTML = `
                <div class="order-card">
                    <div style="text-align: center; color: var(--error-color);">
                        <h3>‚ùå Order Not Found</h3>
                        <p>${message}</p>
                        <button class="btn" onclick="window.location.href='/studio'">‚Üê Back to Studio</button>
                    </div>
                </div>
            `;
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'created': 'Payment Pending',
                'paid': 'Payment Completed',
                'failed': 'Payment Failed',
                'expired': 'Order Expired',
                'cancelled': 'Order Cancelled'
            };
            return statusMap[status] || status;
        }

        // Refresh order status
        async function refreshOrderStatus() {
            if (!currentOrderId) return;

            const refreshBtn = document.getElementById('refresh-text');
            const refreshSpinner = document.getElementById('refresh-spinner');

            refreshBtn.textContent = 'Refreshing...';
            refreshSpinner.style.display = 'block';

            try {
                // Reset QR generation attempts on manual refresh
                qrGenerationAttempts = 0;
                console.log('Manual refresh triggered, resetting attempt counter');

                await loadOrderStatus(currentOrderId);
                // Show success feedback
                refreshBtn.textContent = 'Refreshed!';
                setTimeout(() => {
                    refreshBtn.textContent = 'Refresh Status';
                }, 2000);
            } catch (error) {
                refreshBtn.textContent = 'Refresh Failed';
                setTimeout(() => {
                    refreshBtn.textContent = 'Refresh Status';
                }, 2000);
            } finally {
                refreshSpinner.style.display = 'none';
            }
        }

        // Download QR code
        function downloadQR(qrCodeData, workshopTitle) {
            const link = document.createElement('a');
            link.download = `${workshopTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_qr_code.png`;
            link.href = `data:image/png;base64,${qrCodeData}`;
            link.click();
        }

        // Share QR code
        async function shareQR(qrCodeData, workshopTitle) {
            try {
                // Convert base64 to blob
                const response = await fetch(`data:image/png;base64,${qrCodeData}`);
                const blob = await response.blob();
                const file = new File([blob], `${workshopTitle}_qr_code.png`, { type: 'image/png' });

                if (navigator.share) {
                    await navigator.share({
                        title: `${workshopTitle} - Registration QR`,
                        text: `Registration QR code for ${workshopTitle}`,
                        files: [file]
                    });
                } else {
                    // Fallback: copy to clipboard or download
                    downloadQR(qrCodeData, workshopTitle);
                }
            } catch (error) {
                console.error('Error sharing QR:', error);
                // Fallback to download
                downloadQR(qrCodeData, workshopTitle);
            }
        }

        // Manually trigger QR code generation
        async function triggerQRGeneration() {
            if (!currentOrderId) return;

            const loadingText = document.getElementById('qr-loading-text');
            const loadingSpinner = document.getElementById('qr-loading-spinner');

            // Update UI to show generation in progress
            if (loadingText) loadingText.textContent = 'Generating QR codes...';
            if (loadingSpinner) loadingSpinner.style.display = 'block';

            try {
                // Call the QR generation trigger endpoint
                const response = await fetch('/api/orders/qr-generation/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to trigger QR generation');
                }

                const result = await response.json();
                console.log('QR generation result:', result);

                // Wait a moment for QR generation to complete
                setTimeout(() => {
                    refreshOrderStatus();
                }, 3000);

            } catch (error) {
                console.error('Error triggering QR generation:', error);
                if (loadingText) loadingText.textContent = 'QR generation failed. Please try again.';
                if (loadingSpinner) loadingSpinner.style.display = 'none';

                // Show error message
                setTimeout(() => {
                    if (loadingText) loadingText.textContent = 'Generating QR code...';
                }, 3000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const orderId = getOrderIdFromUrl();
            if (orderId) {
                currentOrderId = orderId;
                loadOrderStatus(orderId);

                // Auto-refresh for pending orders every 30 seconds with timeout
                refreshInterval = setInterval(() => {
                    // Only auto-refresh if order is still loading/pending
                    const statusElement = document.querySelector('.order-status');
                    const qrLoadingSection = document.getElementById('qr-loading-section');

                    if (statusElement && (statusElement.classList.contains('created') || statusElement.classList.contains('paid'))) {
                        if (qrLoadingSection && qrGenerationAttempts < maxQrGenerationAttempts) {
                            qrGenerationAttempts++;
                            console.log(`Auto-refresh attempt ${qrGenerationAttempts}/${maxQrGenerationAttempts}`);
                            loadOrderStatus(orderId);
                        } else if (qrLoadingSection && qrGenerationAttempts >= maxQrGenerationAttempts) {
                            // Stop auto-refresh and show timeout message
                            clearInterval(refreshInterval);
                            const loadingText = document.getElementById('qr-loading-text');
                            const loadingSpinner = document.getElementById('qr-loading-spinner');
                            if (loadingText) {
                                loadingText.innerHTML = 'QR code generation is taking longer than expected.<br>Please try the "Generate QR Now" button or contact support.';
                            }
                            if (loadingSpinner) loadingSpinner.style.display = 'none';
                            console.log('Auto-refresh stopped due to max attempts reached');
                        } else {
                            loadOrderStatus(orderId);
                        }
                    }
                }, 30000);
            } else {
                displayError('Order ID not provided');
            }
        });

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            // Reset counters
            qrGenerationAttempts = 0;
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="description" content="Book dance workshops at {{ studio_name }}. Discover and book classes from top choreographers in your area.">
    <meta name="keywords" content="dance workshop, {{ studio_name }}, dance classes, choreography, booking">
    <meta property="og:title" content="{{ studio_name }} - Workshops">
    <meta property="og:description" content="Book dance workshops at {{ studio_name }}. Discover and book classes from top choreographers.">
    <meta property="og:image" content="{{ studio.image_url if studio.image_url else '/static/assets/logo.png' }}">
    <meta property="og:url" content="{{ current_url }}">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <title>{{ studio_name }} - Dance Workshops | Nachna</title>
    <link rel="icon" type="image/png" href="/static/assets/logo.png">
    <link rel="apple-touch-icon" href="/static/assets/logo.png">
    
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
            --background-gradient: linear-gradient(135deg, #0A0A0F 0%, #1A1A2E 25%, #16213E 50%, #0F3460 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            --accent-blue: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            --accent-green: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --accent-purple: #8B5CF6;
            --accent-pink: linear-gradient(135deg, #FF006E 0%, #DC2626 100%);
            --instagram-gradient: linear-gradient(135deg, #E4405F 0%, #C13584 50%, #833AB4 100%);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --hover-shadow: 0 12px 40px rgba(0, 212, 255, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00D4FF;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Main Container */
        .main-container {
            min-height: 100vh;
            position: relative;
        }
        
        /* Back Button */
        .back-button {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.75rem;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 44px;
            height: 44px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .back-button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Auth Container */
        .auth-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .auth-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 80px;
            justify-content: center;
        }

        .auth-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .auth-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .profile-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--primary-gradient);
            transition: transform 0.2s ease;
            padding: 0;
        }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

        .profile-fallback {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease;
            padding: 0;
        }

        .profile-fallback:hover {
            transform: scale(1.05);
        }
        
        /* Content Container */
        .content {
            padding-top: 6rem;
            padding-bottom: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        /* Studio Header Card */
        .studio-header {
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1.5px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .studio-header-content {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }
        
        .studio-image-container {
            flex-shrink: 0;
            position: relative;
        }
        
        .studio-image {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            object-fit: cover;
            background: var(--primary-gradient);
        }
        
        .studio-image-fallback {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--glass-border);
        }
        
        .studio-info {
            flex: 1;
            min-width: 0;
        }
        
        .studio-name-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .studio-name {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 1.2px;
            line-height: 1.3;
            flex: 0 1 auto;
            min-width: 0;
            overflow-wrap: break-word;
        }
        
        .instagram-icon {
            width: 40px;
            height: 40px;
            border-radius: 0;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }
        
        .instagram-icon:hover {
            opacity: 0.7;
        }
        
        .instagram-icon svg {
            width: 36px;
            height: 36px;
            fill: url(#instagram-gradient);
        }
        
        .studio-instagram-icon {
            width: 32px;
            height: 32px;
            border-radius: 0;
            background: none;
            display: flex !important;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }
        
        .studio-instagram-icon:hover {
            opacity: 0.7;
        }
        
        .studio-instagram-icon svg {
            width: 28px;
            height: 28px;
            fill: url(#studio-instagram-gradient);
        }
        
        .studio-badges {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .studio-type-badge {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #00D4FF;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .share-button {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 0.5rem;
            color: #00D4FF;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .share-button:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.05);
        }
        
        .share-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        
        /* Section Headers */
        .section-header {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .section-icon-container {
            background: rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-icon {
            width: 20px;
            height: 20px;
            fill: #00D4FF;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #00D4FF;
            letter-spacing: 0.5px;
        }
        
        /* Day Sections */
        .day-section {
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(2px);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .day-header {
            background: var(--accent-blue);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .workshops-grid {
            display: grid;
            gap: 1rem;
        }
        
        /* Workshop Cards */
        .workshop-card {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .workshop-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .workshop-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }
        
        .workshop-card:hover::before {
            opacity: 1;
        }
        
        .workshop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }
        
        .workshop-artist-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.3;
            flex: 0 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist-name-container {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
            min-width: 0;
            overflow-wrap: break-word;
        }

        .artist-name-instagram-icon {
            width: 24px;
            height: 24px;
            border-radius: 0;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }

        .artist-name-instagram-icon:hover {
            opacity: 0.7;
        }

        .artist-name-instagram-icon svg {
            width: 20px;
            height: 20px;
            fill: url(#instagram-gradient);
        }
        
        .workshop-date-badge {
            background: var(--accent-blue);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .workshop-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: space-between;
        }
        
        .artist-avatars {
            flex-shrink: 0;
        }
        
        .single-avatar {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            object-fit: cover;
            background: var(--primary-gradient);
            transition: transform 0.2s ease;
        }
        
        .single-avatar:hover {
            transform: scale(1.05);
        }
        
        .avatar-fallback {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            transition: transform 0.2s ease;
        }
        
        .avatar-fallback:hover {
            transform: scale(1.05);
        }
        
        .multiple-avatars {
            position: relative;
            width: 66px;
            height: 42px;
            transition: transform 0.2s ease;
        }
        
        .multiple-avatars:hover {
            transform: scale(1.05);
        }
        
        .avatar-stack {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            object-fit: cover;
        }
        
        .avatar-stack:nth-child(1) { left: 0; }
        .avatar-stack:nth-child(2) { left: 20px; }
        .avatar-stack:nth-child(3) { left: 40px; }
        
        .avatar-count {
            position: absolute;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(26, 26, 46, 0.9);
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .workshop-details {
            flex: 1;
            min-width: 0;
        }

        .workshop-details-column {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .workshop-detail-row {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .workshop-detail-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Compact layout for desktop - make rows side by side when possible */
        @media (min-width: 769px) {
            .workshop-details-column {
                gap: 0.175rem;
            }
            
            .workshop-detail-row {
                font-size: 0.8rem;
                gap: 0.375rem;
            }
            
            .workshop-detail-row svg {
                width: 14px !important;
                height: 14px !important;
                flex-shrink: 0;
            }
            
            .workshop-song-row {
                font-size: 0.9rem !important;
                margin-bottom: 0.125rem;
                font-weight: 600;
            }
            
            /* Make studio and time info more compact side by side */
            .workshop-info-row {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex-wrap: wrap;
            }
        }
        
        .workshop-song, .workshop-song-row {
            color: #00D4FF !important;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .workshop-info-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .workshop-info-row svg {
            width: 14px;
            height: 14px;
            fill: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .workshop-info-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .workshop-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .choreo-button, .artist-instagram-button {
            width: 36px;
            height: 36px;
            border-radius: 0;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            border: none;
            position: relative;
        }

        .choreo-button:hover, .artist-instagram-button:hover {
            opacity: 0.7;
        }

        .choreo-button svg, .artist-instagram-button svg {
            width: 20px;
            height: 20px;
            fill: url(#instagram-gradient);
        }
        
        .multiple-instagram-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #FF006E;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        .register-button {
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            min-width: 100px;
            flex-shrink: 0;
        }
        
        .register-button.nachna {
            background: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.4);
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .register-button.nachna::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .register-button.nachna:hover::before {
            left: 100%;
        }

        .register-button.nachna:hover {
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
            transform: translateY(-2px);
        }

        .register-button.whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .register-button.external {
            background: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .register-button.disabled {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-tertiary);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .register-button:not(.disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .empty-message {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* Error State */
        .error-state {
            text-align: center;
            padding: 3rem 1.5rem;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 24px;
            border: 1px solid rgba(220, 38, 38, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #DC2626;
        }
        
        .error-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #DC2626;
            margin-bottom: 0.5rem;
        }
        
        .error-message {
            color: rgba(220, 38, 38, 0.8);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }
        
        .retry-button {
            background: #DC2626;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .retry-button:hover {
            background: #B91C1C;
            transform: translateY(-1px);
        }
        
        /* Share Modal */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        
        .share-modal.show {
            display: flex;
        }
        
        .share-content {
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            padding: 2rem;
            max-width: 400px;
            width: calc(100% - 2rem);
        }
        
        .share-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .share-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .share-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .share-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .share-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .share-option-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .share-option-text {
            font-weight: 600;
            flex: 1;
        }
        
        .share-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Authentication Modals */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .auth-modal.show {
            display: flex;
        }

        .auth-modal-content {
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            padding: 2rem;
            max-width: 400px;
            width: calc(100% - 2rem);
            position: relative;
        }

        .auth-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .auth-modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .auth-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .auth-modal-body {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Form Styles */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .phone-input-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .country-code {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .form-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.05);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* OTP Input */
        .otp-input-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .otp-input {
            width: 40px;
            height: 40px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            outline: none;
            transition: all 0.3s ease;
        }

        .otp-input:focus {
            border-color: #00D4FF;
            background: rgba(255, 255, 255, 0.1);
        }

        .otp-input:valid {
            border-color: #10B981;
        }

        .otp-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        /* Button Styles */
        .auth-primary-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .auth-primary-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .auth-primary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-secondary-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .auth-secondary-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        .auth-secondary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .resend-text {
            display: none;
        }

        .countdown-text {
            display: block;
        }

        .auth-secondary-btn:not([disabled]) .resend-text {
            display: block;
        }

        .auth-secondary-btn:not([disabled]) .countdown-text {
            display: none;
        }

        .btn-loader {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .auth-error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            color: #EF4444;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: var(--glass-bg);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10001;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-content {
            padding: 0.5rem;
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .profile-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .profile-dropdown-item svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .profile-modal.show {
            display: flex;
        }

        .profile-modal-content {
            background: var(--glass-bg);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            padding: 0;
            max-width: 420px;
            width: calc(100% - 2rem);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .profile-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.25rem;
            font-weight: 700;
            z-index: 1;
        }

        .profile-modal-header {
            padding: 2rem 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .profile-modal-body {
            padding: 1.5rem 2rem 2rem;
        }

        /* Profile Header */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .profile-avatar-large {
            flex-shrink: 0;
        }

        .profile-avatar-large img,
        .profile-avatar-large .profile-fallback-large {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            object-fit: cover;
            border: 3px solid var(--primary-gradient);
        }

        .profile-fallback-large {
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 2rem;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .profile-mobile {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .profile-status {
            display: inline-block;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.complete {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .status-badge.incomplete {
            background: linear-gradient(135deg, #FF006E 0%, #DC2626 100%);
            color: white;
        }

        /* Profile Actions */
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .profile-action-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .profile-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .action-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-profile .action-icon {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        }

        .view-orders .action-icon {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .view-rewards .action-icon {
            background: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
        }

        .action-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
        }

        .action-text {
            flex: 1;
            min-width: 0;
        }

        .action-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }

        .action-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .action-arrow {
            flex-shrink: 0;
            opacity: 0.6;
        }

        .action-arrow svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
        }

        /* Profile Footer */
        .profile-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
        }

        .logout-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            color: #EF4444;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.2);
            transform: translateY(-1px);
        }

        .logout-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        /* Tab Navigation */
        .profile-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 12px 0 0;
            padding: 4px;
            margin-bottom: 0;
        }

        .profile-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .profile-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .profile-tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .profile-tab svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        /* Tab Content */
        .profile-tab-content {
            display: none;
            flex-direction: column;
        }

        .profile-tab-content.active {
            display: flex;
        }

        /* Orders Section */
        .orders-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .refresh-btn {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        .refresh-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-chip {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: var(--primary-gradient);
            border-color: rgba(0, 212, 255, 0.3);
            color: white;
        }

        .orders-loading, .rewards-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .orders-loading .loading-spinner,
        .rewards-loading .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00D4FF;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .orders-error, .orders-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }

        .orders-error button, .rewards-error button {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .bundle-badge {
            background: linear-gradient(45deg, #00D4FF, #9C27B0);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .bundle-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .bundle-info-title {
            color: #00D4FF;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .bundle-info-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .bundle-savings {
            color: #10B981;
            font-weight: 600;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .bundle-workshops {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bundle-workshops-title {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .bundle-workshop-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bundle-workshop-item:last-child {
            margin-bottom: 0;
        }

        .bundle-workshop-name {
            color: #00D4FF;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .bundle-workshop-artists {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .bundle-workshop-details {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        /* Pay Button Styles */
        .pay-btn {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .pay-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .pay-btn:active {
            transform: translateY(0);
        }

        .pay-btn svg {
            stroke-width: 2.5;
        }

        /* Order Action Top Styles */
        .order-action-top {
            margin: 1rem 0;
            display: flex;
            justify-content: flex-start;
        }

        /* Bundle Suggestion Modal Styles */
        .bundle-savings-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-radius: 16px;
            padding: 2rem 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .savings-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            display: block;
            margin-bottom: 0.5rem;
        }

        .savings-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
        }

        .savings-percentage {
            font-size: 1.2rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .bundle-details {
            margin-bottom: 2rem;
        }

        .bundle-details h4 {
            color: #00D4FF;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .bundle-details p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
        }

        .pricing-comparison {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .pricing-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pricing-option.bundle-option {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .pricing-label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .pricing-amount {
            color: #10B981;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .pricing-option.bundle-option .pricing-amount {
            color: #10B981;
        }

        .workshop-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .count-icon {
            font-size: 1.2rem;
        }

        .bundle-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .bundle-action-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .bundle-action-btn.primary {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .bundle-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .bundle-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bundle-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .order-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .order-artists {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.created {
            background: rgba(255, 136, 0, 0.2);
            color: #FF8800;
        }

        .order-status.paid {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .order-status.failed, .order-status.expired {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .order-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .order-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .order-value {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .order-amount {
            color: #00D4FF;
            font-weight: 600;
        }

        /* Rewards Section */
        .rewards-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .rewards-balance {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .balance-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .balance-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .balance-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        .balance-info {
            flex: 1;
        }

        .balance-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .balance-amount {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .balance-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.earned {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .stat-icon.redeemed {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }

        .stat-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .rewards-transactions {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .transactions-header h4 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .transaction-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 2px;
        }

        .transaction-tab {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transaction-tab.active {
            background: var(--primary-gradient);
            color: white;
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .transaction-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .transaction-icon.credit {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .transaction-icon.debit {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .transaction-info {
            flex: 1;
            min-width: 0;
        }

        .transaction-title {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .transaction-desc {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .transaction-amount {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .transaction-amount.credit {
            color: #10B981;
        }

        .transaction-amount.debit {
            color: #EF4444;
        }

        .load-more-btn {
            text-align: center;
            margin-top: 1rem;
        }

        .load-more-btn button {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .load-more-btn button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        /* Enhanced Order Cards with Rewards Details */
        .order-rewards {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .order-reward-label {
            color: var(--text-secondary);
        }

        .order-reward-value {
            font-weight: 500;
        }

        .order-reward-value.rewards-used {
            color: #F59E0B;
        }

        .order-reward-value.cashback-earned {
            color: #10B981;
        }

        /* Registration Button Styles */
        .register-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .register-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .register-btn svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        /* Special Nachna Button Styling */
        .register-btn.nachna {
            background: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.4);
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .register-btn.nachna::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .register-btn.nachna:hover::before {
            left: 100%;
        }

        .register-btn.nachna:hover {
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
            transform: translateY(-2px);
        }

        /* WhatsApp Button Styling */
        .register-btn.whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        }

        .register-btn.whatsapp:hover {
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .order-registration-action {
            margin-top: 1rem;
            text-align: center;
        }

        .qr-generate-btn, .qr-view-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qr-generate-btn:hover, .qr-view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .qr-generate-btn svg, .qr-view-btn svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        .qr-generating {
            background: rgba(255, 136, 0, 0.2);
            color: #FF8800;
            border: 1px solid rgba(255, 136, 0, 0.3);
            cursor: not-allowed;
        }

        .qr-generating:hover {
            transform: none;
            box-shadow: none;
        }

        /* QR Code Modal */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            backdrop-filter: blur(15px);
        }

        .qr-modal.show {
            display: flex;
        }

        /* Prevent body scroll when QR modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .qr-modal-content {
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .qr-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11001;
            transition: all 0.3s ease;
        }

        .qr-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .qr-modal-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .qr-modal-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            letter-spacing: 1.2;
        }

        .qr-workshop-info {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1rem;
        }

        .qr-workshop-title {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .qr-workshop-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
        }

        .qr-modal-body {
            padding: 1.5rem;
        }

        .qr-loading, .qr-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .qr-loading .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00D4FF;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .qr-code-display {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 12px;
            display: inline-block;
        }

        .qr-code-display canvas {
            display: block;
            border-radius: 8px;
        }

        .qr-actions {
            display: flex;
            gap: 1rem;
            width: 100%;
            justify-content: center;
        }

        .qr-action-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .qr-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .qr-action-btn svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 12000;
            min-width: 300px;
            max-width: 400px;
            padding: 0;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            color: white;
        }

        .toast-loading .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #00D4FF;
            animation: spin 1s linear infinite;
        }

        .toast-success {
            background: rgba(16, 185, 129, 0.9);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .toast-success svg {
            color: #10B981;
            stroke: #10B981;
        }

        /* Workshop Card Styles */
        .workshop-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .workshop-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
        }

        .workshop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .workshop-info {
            flex: 1;
            min-width: 0;
        }

        .workshop-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .workshop-artist {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .workshop-time {
            text-align: right;
        }

        .workshop-time .date {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .workshop-time .time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .workshop-details {
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .detail-value {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .workshop-actions {
            text-align: center;
        }

        /* MOBILE APP-LIKE DESIGN - EXACT MATCH TO FLUTTER APP */
        @media (max-width: 768px) {
            /* Reset base styles for mobile */
            body {
                font-size: 14px;
                line-height: 1.4;
                -webkit-text-size-adjust: 100%;
                padding: 0;
                margin: 0;
            }
            
            /* Back button - positioned like app's SafeArea */
            .back-button {
                position: fixed;
                top: calc(env(safe-area-inset-top, 0px) + 2rem);
                left: 1.5rem;
                width: 32px;
                height: 32px;
                padding: 8px;
                background: transparent;
                border: none;
                z-index: 1000;
            }

            /* Auth button - positioned like app's SafeArea */
            .auth-container {
                position: fixed;
                top: calc(env(safe-area-inset-top, 0px) + 2rem);
                right: 1.5rem;
                z-index: 1000;
            }

            .auth-button {
                width: 32px;
                height: 32px;
                padding: 8px;
                font-size: 0.75rem;
                min-width: 32px;
            }

            .auth-icon {
                width: 16px;
                height: 16px;
            }

            .profile-avatar, .profile-fallback {
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            /* Profile Modal Mobile Styles */
            .profile-modal-content {
                width: calc(100% - 1rem);
                max-width: none;
                margin: 0 0.5rem;
                max-height: calc(100vh - 2rem);
            }

            .profile-modal-header {
                padding: 1.5rem 1.5rem 1rem;
            }

            .profile-modal-body {
                padding: 1.5rem;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .profile-avatar-large img,
            .profile-avatar-large .profile-fallback-large {
                width: 70px;
                height: 70px;
                font-size: 1.75rem;
            }

            .profile-info {
                text-align: center;
            }

            .profile-name {
                font-size: 1.125rem;
            }

            .profile-actions {
                gap: 0.5rem;
            }

            .profile-action-btn {
                padding: 0.875rem;
            }

            .action-icon {
                width: 36px;
                height: 36px;
            }

            .action-icon svg {
                width: 18px;
                height: 18px;
            }

            .action-title {
                font-size: 0.9rem;
            }

            .action-subtitle {
                font-size: 0.8rem;
            }

            /* Profile Modal Mobile Styles */
            .profile-modal-content {
                width: calc(100% - 1rem);
                max-width: none;
                margin: 0 0.5rem;
                max-height: calc(100vh - 2rem);
            }

            .profile-tabs {
                padding: 4px;
                margin-bottom: 0;
            }

            .profile-tab {
                font-size: 0.8rem;
                padding: 10px 6px;
            }

            .profile-modal-header {
                padding: 1.5rem 1.5rem 1rem;
            }

            .profile-modal-body {
                padding: 1.5rem;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .profile-avatar-large img,
            .profile-avatar-large .profile-fallback-large {
                width: 70px;
                height: 70px;
                font-size: 1.75rem;
            }

            .profile-info {
                text-align: center;
            }

            .profile-name {
                font-size: 1.125rem;
            }

            .profile-actions {
                gap: 0.75rem;
            }

            .profile-action-btn {
                padding: 0.875rem;
                gap: 0.75rem;
            }

            .action-icon {
                width: 36px;
                height: 36px;
            }

            .action-icon svg {
                width: 18px;
                height: 18px;
            }

            .action-title {
                font-size: 0.9rem;
            }

            .action-subtitle {
                font-size: 0.8rem;
            }

            .filter-chips {
                gap: 6px;
            }

            .filter-chip {
                padding: 6px 12px;
                font-size: 0.8rem;
                flex-shrink: 0;
            }

            .order-card {
                padding: 0.875rem;
            }

            .order-title {
                font-size: 0.9rem;
            }

            .order-artists {
                font-size: 0.8rem;
            }

            .order-status {
                font-size: 0.7rem;
                padding: 3px 10px;
            }

            .order-label,
            .order-value {
                font-size: 0.8rem;
            }

            .balance-card {
                padding: 1.25rem;
            }

            .balance-amount {
                font-size: 1.25rem;
            }

            .balance-stats {
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.875rem;
            }

            .stat-value {
                font-size: 1rem;
            }

            .rewards-transactions {
                padding: 1.25rem;
            }

            .transactions-header h4 {
                font-size: 1rem;
            }

            .transaction-tab {
                font-size: 0.7rem;
                padding: 5px 10px;
            }

            .transaction-item {
                padding: 0.875rem;
            }

            .transaction-title {
                font-size: 0.8rem;
            }

            .transaction-desc,
            .transaction-amount {
                font-size: 0.75rem;
            }

            .load-more-btn button {
                padding: 0.625rem 1.5rem;
                font-size: 0.8rem;
            }
            
            .back-button svg {
                width: 16px;
                height: 16px;
                fill: white;
            }
            
            /* Main content - matches ListView padding in app */
            .content {
                padding-top: calc(env(safe-area-inset-top, 0px) + 5rem);
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem);
            }
            
            /* Studio Header - exact match to app's Container with decoration */
            .studio-header {
                margin-bottom: 1.5rem;
                padding: 1.5rem;
                border-radius: 20px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
                border: 1.5px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            }
            
            .studio-header-content {
                display: flex;
                align-items: flex-start;
                gap: 1.5rem;
            }
            
            /* Studio image - matches app's avatarSizeLarge */
            .studio-image, .studio-image-fallback {
                width: 80px;
                height: 80px;
                border-radius: 16px;
                border: 1.5px solid rgba(255, 255, 255, 0.2);
                flex-shrink: 0;
            }
            
            .studio-image-fallback {
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(157, 78, 221, 0.3) 100%);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .studio-info {
                flex: 1;
                min-width: 0;
            }
            
            /* Studio name row - matches app's Row with crossAxisAlignment.center */
            .studio-name-row {
                display: flex;
                align-items: center;
                gap: 0.375rem;
                margin-bottom: 0.5rem;
            }
            
            .studio-name {
                font-size: 1.375rem;
                font-weight: 700;
                letter-spacing: 0.5px;
                color: white;
                line-height: 1.2;
                flex: 0 1 auto;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            /* Studio Instagram icon - matches app's small icon size */
            .studio-instagram-icon {
                width: 28px;
                height: 28px;
                border-radius: 0;
                background: none;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                cursor: pointer;
            }

            .studio-instagram-icon svg {
                width: 24px;
                height: 24px;
                fill: url(#studio-instagram-gradient);
            }
            
            /* Studio badges row - matches app's Row layout */
            .studio-badges {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            
            /* Dance Studio badge - matches app's Container with gradient */
            .studio-type-badge {
                display: flex;
                align-items: center;
                gap: 0.375rem;
                padding: 0.375rem 0.75rem;
                border-radius: 16px;
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(157, 78, 221, 0.2) 100%);
                border: 1px solid rgba(0, 212, 255, 0.3);
                font-size: 0.75rem;
                font-weight: 600;
                color: #00D4FF;
            }
            
            .studio-type-badge svg {
                width: 12px;
                height: 12px;
                fill: currentColor;
            }
            
            /* Share button - matches app's small GestureDetector */
            .share-button {
                width: 32px;
                height: 32px;
                padding: 0.375rem;
                border-radius: 8px;
                background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(157, 78, 221, 0.2) 100%);
                border: 1px solid rgba(0, 212, 255, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                color: #00D4FF;
            }
            
            .share-button svg {
                width: 12px;
                height: 12px;
                fill: currentColor;
            }
            
            /* Section headers - app style */
            .section-header {
                padding: 1rem 1.25rem;
                margin-bottom: 1rem;
                border-radius: 16px;
            }
            
            .section-title {
                font-size: 1rem;
                font-weight: 700;
            }
            
            /* Day sections - compact like app */
            .day-section {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 16px;
            }
            
            .day-header {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
                font-weight: 700;
                border-radius: 10px;
                margin-bottom: 0.75rem;
            }
            
            .workshops-grid {
                gap: 0.75rem;
                grid-template-columns: 1fr;
            }
            
            /* Workshop cards - matches app's _buildWorkshopCard exactly */
            .workshop-card {
                margin-bottom: 1rem;
                border-radius: 16px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(2px);
                overflow: hidden;
                padding: 1rem;
            }
            
            .workshop-card:hover {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
                transform: none;
            }
            
            /* Workshop header - matches app's header Row with artist name and date */
            .workshop-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
                gap: 0.75rem;
            }
            
            /* Artist name - matches app's main title style */
            .workshop-artist-name {
                font-size: 1rem;
                font-weight: 700;
                line-height: 1.2;
                color: white;
                flex: 0 1 auto;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .artist-name-container {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                flex: 1;
                min-width: 0;
            }

            .artist-name-instagram-icon {
                width: 20px;
                height: 20px;
                border-radius: 0;
                background: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: opacity 0.3s ease;
                flex-shrink: 0;
            }

            .artist-name-instagram-icon:hover {
                opacity: 0.7;
            }

            .artist-name-instagram-icon svg {
                width: 16px;
                height: 16px;
                fill: url(#instagram-gradient);
            }
            
            /* Date badge - matches app's blue gradient badge */
            .workshop-date-badge {
                font-size: 0.75rem;
                font-weight: 600;
                padding: 0.375rem 0.75rem;
                border-radius: 8px;
                background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
                color: white;
                flex-shrink: 0;
                white-space: nowrap;
                text-align: center;
                min-width: 90px;
            }
            
            /* Workshop song row - cyan colored song name */
            .workshop-song-row {
                color: #00D4FF !important;
                font-size: 0.85rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                line-height: 1.2;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Workshop content - matches app's main content Row */
            .workshop-content {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                justify-content: space-between;
            }
            
            /* Workshop details column */
            .workshop-details-column {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }
            
            /* Workshop detail rows with icons */
            .workshop-detail-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .workshop-detail-text {
                color: rgba(255, 255, 255, 0.8);
                font-size: 0.8rem;
                font-weight: 500;
                line-height: 1.2;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Action buttons container */
            .action-buttons {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex-shrink: 0;
            }
            
            /* Register button styling */
            .register-button {
                flex: 0 0 auto;
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem;
                font-weight: 600;
                border-radius: 8px;
                border: none;
                color: white;
                cursor: pointer;
                min-width: 85px;
                text-align: center;
                text-decoration: none;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                transition: all 0.2s ease;
            }
            
            .register-button:hover:not(.disabled) {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            
            .register-button.nachna {
                background: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
                box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
            }

            .register-button.whatsapp {
                background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
            }

            .register-button.disabled {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.5);
                cursor: not-allowed;
                box-shadow: none;
            }
            
            /* Artist avatars - matches app's _buildArtistAvatars exactly */
            .artist-avatars {
                flex-shrink: 0;
            }
            
            .single-avatar, .avatar-fallback {
                width: 42px;
                height: 42px;
                border-radius: 10px;
                object-fit: cover;
                transition: transform 0.2s ease;
            }
            
            .single-avatar:hover, .avatar-fallback:hover {
                transform: scale(1.05);
            }
            
            .avatar-fallback {
                font-size: 1.1rem;
                font-weight: 700;
                background: linear-gradient(135deg, #00D4FF 0%, #9C27B0 100%);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Multiple avatars - matches app's overlapping avatar system */
            .multiple-avatars {
                width: 66px;
                height: 42px;
                position: relative;
                transition: transform 0.2s ease;
            }
            
            .multiple-avatars:hover {
                transform: scale(1.05);
            }
            
            .avatar-stack {
                position: absolute;
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                object-fit: cover;
                box-shadow: 0 2px 4px rgba(0, 212, 255, 0.2);
            }
            
            .avatar-stack:nth-child(1) { left: 0; z-index: 3; }
            .avatar-stack:nth-child(2) { left: 24px; z-index: 2; }
            .avatar-stack:nth-child(3) { left: 48px; z-index: 1; }
            
            .avatar-count {
                position: absolute;
                right: 0;
                width: 36px;
                height: 36px;
                border-radius: 8px;
                background: rgba(26, 26, 46, 0.9);
                border: 2px solid white;
                font-size: 0.7rem;
                font-weight: 700;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 4;
            }
            
            /* Workshop details - matches app's info column */
            .workshop-details {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }
            
            /* Song name - matches app's blue song title */
            .workshop-song {
                font-size: 0.8rem;
                font-weight: 600;
                color: #00D4FF;
                line-height: 1.2;
                margin-bottom: 0.125rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Info rows - matches app's icon + text rows */
            .workshop-info-row {
                display: flex;
                align-items: center;
                gap: 0.375rem;
                margin-bottom: 0.125rem;
            }
            
            .workshop-info-row svg {
                width: 12px;
                height: 12px;
                flex-shrink: 0;
                opacity: 0.7;
            }
            
            .workshop-info-text {
                font-size: 0.75rem;
                font-weight: 500;
                color: rgba(255, 255, 255, 0.8);
                line-height: 1.2;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            
            .action-buttons {
                display: flex;
                align-items: center;
                gap: 0.375rem;
                flex-shrink: 0;
            }
            
            /* Action buttons - matches app's Instagram buttons */
            .artist-instagram-button {
                width: 32px;
                height: 32px;
                border-radius: 0;
                background: none;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                position: relative;
                flex-shrink: 0;
                transition: opacity 0.3s ease;
            }

            .artist-instagram-button:hover {
                opacity: 0.7;
            }

            .artist-instagram-button svg {
                width: 20px;
                height: 20px;
                fill: url(#instagram-gradient);
            }
            
            .multiple-instagram-count {
                position: absolute;
                top: -4px;
                right: -4px;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: #FF006E;
                color: white;
                font-size: 0.6rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid white;
            }
            
            
            /* Upcoming workshops grid - single column like app */
            #upcoming-content.workshops-grid {
                grid-template-columns: 1fr;
            }
            
            /* Empty/Error states - mobile sizing */
            .empty-state, .error-state {
                padding: 2rem 1.5rem;
                margin: 1rem 0;
                border-radius: 16px;
            }
            
            .empty-icon, .error-icon {
                font-size: 2.5rem;
            }
            
            .empty-title, .error-title {
                font-size: 1.125rem;
                font-weight: 700;
            }
            
            .empty-message, .error-message {
                font-size: 0.875rem;
                line-height: 1.4;
            }
            
            /* Share modal - full mobile experience */
            .share-modal {
                padding: 0;
                align-items: flex-end;
            }
            
            .share-content {
                margin: 0;
                width: 100%;
                max-width: none;
                border-radius: 20px 20px 0 0;
                padding: 1.5rem 1rem calc(env(safe-area-inset-bottom, 0px) + 1rem);
            }
            
            .share-title {
                font-size: 1.125rem;
                font-weight: 700;
            }
            
            .share-subtitle {
                font-size: 0.875rem;
            }
            
            .share-option {
                padding: 1rem;
                border-radius: 12px;
                font-size: 0.9rem;
            }
            
            .share-option-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
            }
            
            .share-close {
                width: 28px;
                height: 28px;
                font-size: 1.25rem;
                font-weight: 700;
            }
        }
        
        /* iPhone SE and very small screens */
        @media (max-width: 375px) {
            .content {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .studio-header {
                padding: 1.25rem;
            }
            
            .studio-name {
                font-size: 1.375rem;
            }
            
            .workshop-card {
                padding: 0.875rem;
            }
            
            .workshop-artist-name {
                font-size: 0.95rem;
            }
            
            .workshop-song {
                font-size: 0.8rem;
            }
            
            .register-button {
                font-size: 0.75rem;
                padding: 0.625rem 0.75rem;
            }
        }
        
        @media (min-width: 769px) {
            .content {
                padding-left: 2rem;
                padding-right: 2rem;
            }
            
            .workshops-grid {
                grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .workshops-grid {
                grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            }
        }
        
        /* Touch-friendly improvements for mobile */
        @media (max-width: 768px) {
            /* Better mobile scrolling */
            html {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            /* Prevent text selection on interactive elements */
            .workshop-card,
            .register-button,
            .choreo-button,
            .artist-instagram-button,
            .share-button,
            .back-button,
            .studio-instagram-icon {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Touch feedback for buttons */
            .register-button:active {
                transform: scale(0.96);
                transition: transform 0.1s ease;
            }
            
            .choreo-button:active,
            .artist-instagram-button:active,
            .share-button:active,
            .studio-instagram-icon:active {
                transform: scale(0.9);
                transition: transform 0.1s ease;
            }
            
            .back-button:active {
                transform: scale(0.85);
                transition: transform 0.1s ease;
            }
            
            .workshop-card:active {
                background: rgba(255, 255, 255, 0.15);
                transition: background 0.1s ease;
            }
            
            /* Remove desktop hover effects on mobile */
            .workshop-card:hover {
                transform: none !important;
            }
            
            .register-button:hover,
            .choreo-button:hover,
            .artist-instagram-button:hover {
                transform: none !important;
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus States */
        .register-button:focus,
        .choreo-button:focus,
        .artist-instagram-button:focus,
        .back-button:focus,
        .share-button:focus,
        .studio-instagram-icon:focus {
            outline: 2px solid #00D4FF;
            outline-offset: 2px;
        }
        
        /* Mobile Focus States */
        @media (max-width: 768px) {
            .register-button:focus,
            .choreo-button:focus,
            .artist-instagram-button:focus,
            .studio-instagram-icon:focus {
                outline: 3px solid #00D4FF;
                outline-offset: 1px;
            }
        }

        /* Bundle Selection Modal Styles */
        .bundle-modal {
            max-width: 600px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bundle-modal .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 0;
        }

        .current-workshop-info {
            margin-bottom: 1.5rem;
        }

        .current-workshop-info h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .workshop-summary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem;
        }

        .workshop-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .workshop-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .bundle-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .option-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.25rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .option-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .bundle-card {
            border: 2px solid transparent;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(156, 39, 176, 0.1));
        }

        .bundle-card:hover {
            border-color: rgba(0, 212, 255, 0.4);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .option-header h4 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin: 0;
        }

        .bundle-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bundle-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .pricing-comparison {
            margin-bottom: 1rem;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .price-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .price-value {
            font-weight: 600;
        }

        .price-value.strikethrough {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .price-value.highlight {
            color: #00D4FF;
            font-size: 1.1rem;
        }

        .bundle-price .price-value.highlight {
            color: #10B981;
        }

        .savings-badge {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .workshop-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .individual-option {
            border-top: 1px solid var(--glass-border);
            padding-top: 1.5rem;
            margin-top: 1rem;
        }

        .individual-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .price-tag {
            background: var(--accent-blue);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .option-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .option-button {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .option-button.primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--card-shadow);
        }

        .option-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .option-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .option-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .option-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: var(--card-shadow);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .bundle-modal {
                width: 95vw;
                max-height: 85vh;
            }

            .modal-header,
            .modal-body {
                padding: 1rem;
            }

            .option-card {
                padding: 1rem;
            }

            .option-button {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading studio details...</div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="main-container" class="main-container" style="display: none;">
        <!-- Back Button -->
        <a href="/" class="back-button" aria-label="Go back to home">
            <svg viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
            </svg>
        </a>

        <!-- Login/Profile Button -->
        <div id="auth-container" class="auth-container">
            <button id="auth-button" class="auth-button" onclick="handleAuth()">
                <span class="auth-text">Login</span>
                <svg class="auth-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </button>
        </div>
        
        <!-- Content -->
        <div class="content">
            <!-- Studio Header -->
            <div class="studio-header">
                <div class="studio-header-content">
                    <!-- Studio Image -->
                    <div class="studio-image-container">
                        <img id="studio-image" class="studio-image" src="" alt="Studio" style="display: none;">
                        <div id="studio-image-fallback" class="studio-image-fallback" style="display: flex;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                                <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Studio Info -->
                    <div class="studio-info">
                        <div class="studio-name-row">
                            <h1 id="studio-name" class="studio-name">Loading...</h1>
                            <div id="studio-instagram-icon" class="studio-instagram-icon" style="display: none;">
                                <svg viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="studio-instagram-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#833AB4"/>
                                            <stop offset="50%" style="stop-color:#E4405F"/>
                                            <stop offset="100%" style="stop-color:#F77737"/>
                                        </linearGradient>
                                    </defs>
                                    <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8A1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5a5 5 0 0 1-5 5a5 5 0 0 1-5-5a5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3z"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="studio-badges">
                            <div class="studio-type-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                                </svg>
                                Dance Studio
                            </div>
                            <div class="share-button" onclick="openShareModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- This Week Section -->
            <div id="this-week-section" style="display: none;">
                <div class="section-header">
                    <div class="section-icon-container">
                        <svg class="section-icon" viewBox="0 0 24 24">
                            <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2-7h-3V2h-2v2H8V2H6v2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H3V8h14v12z"/>
                        </svg>
                    </div>
                    <h2 class="section-title">This Week</h2>
                </div>
                <div id="this-week-content"></div>
            </div>
            
            <!-- Upcoming Section -->
            <div id="upcoming-section" style="display: none;">
                <div class="section-header">
                    <div class="section-icon-container">
                        <svg class="section-icon" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <h2 class="section-title">Upcoming Workshops</h2>
                </div>
                <div id="upcoming-content" class="workshops-grid"></div>
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">🎭</div>
                <h3 class="empty-title">No Workshops Scheduled</h3>
                <p class="empty-message">This studio doesn't have any workshops scheduled at the moment. Check back later for new updates!</p>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="error-state" style="display: none;">
                <div class="error-icon">❌</div>
                <h3 class="error-title">Error Loading Workshops</h3>
                <p id="error-message" class="error-message">Failed to load workshops. Please check your internet connection and try again.</p>
                <button class="retry-button" onclick="loadData()">Try Again</button>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="share-modal">
        <div class="share-content">
            <div class="share-close" onclick="closeShareModal()">×</div>
            <div class="share-header">
                <h3 class="share-title">Share Studio</h3>
                <p class="share-subtitle">Let others know about this amazing studio!</p>
            </div>
            <div class="share-options">
                <a href="/bundles" class="share-option">
                    <div class="share-option-icon" style="background: linear-gradient(45deg, #00D4FF, #9C27B0);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M9 12l2 2 4-4"/>
                            <circle cx="12" cy="12" r="9"/>
                        </svg>
                    </div>
                    <span class="share-option-text">View Bundles</span>
                </a>

                <a href="#" id="whatsapp-share" class="share-option">
                    <div class="share-option-icon" style="background: #25D366;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488"/>
                        </svg>
                    </div>
                    <span class="share-option-text">Share on WhatsApp</span>
                </a>
                
                <a href="#" id="instagram-share" class="share-option">
                    <div class="share-option-icon" style="background: linear-gradient(45deg, #E4405F, #C13584, #833AB4);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8A1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5a5 5 0 0 1-5 5a5 5 0 0 1-5-5a5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3z"/>
                        </svg>
                    </div>
                    <span class="share-option-text">Share to Instagram Story</span>
                </a>
                
                <a href="#" id="generic-share" class="share-option">
                    <div class="share-option-icon" style="background: var(--primary-gradient);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </div>
                    <span class="share-option-text">More...</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <!-- Bundle Suggestion Modal -->
    <div id="bundle-suggestion-modal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-close" onclick="closeBundleSuggestionModal()">×</div>
            <div class="auth-modal-header">
                <h3 class="auth-modal-title">💰 Great Choice!</h3>
                <p class="auth-modal-subtitle" id="bundle-suggestion-subtitle">Save money by purchasing the complete bundle</p>
            </div>
            <div class="auth-modal-body">
                <div id="bundle-suggestion-content">
                    <div class="bundle-savings-card">
                        <div class="savings-amount" id="savings-amount">₹0</div>
                        <div class="savings-text">You Save</div>
                        <div class="savings-percentage" id="savings-percentage">0%</div>
                    </div>

                    <div class="bundle-details">
                        <h4 id="bundle-name">Workshop Bundle</h4>
                        <p id="bundle-description">Complete workshop package</p>

                        <div class="pricing-comparison">
                            <div class="pricing-option">
                                <span class="pricing-label">Individual Purchase:</span>
                                <span class="pricing-amount" id="individual-price">₹0</span>
                            </div>
                            <div class="pricing-option bundle-option">
                                <span class="pricing-label">Bundle Purchase:</span>
                                <span class="pricing-amount" id="bundle-price">₹0</span>
                            </div>
                        </div>

                        <div class="workshop-count">
                            <span class="count-icon">🎭</span>
                            <span id="workshop-count">0 workshops</span>
                        </div>
                    </div>
                </div>

                <div class="bundle-actions">
                    <button class="bundle-action-btn primary" onclick="purchaseBundle()">
                        <span>🎯</span>
                        Get Bundle & Save
                    </button>
                    <button class="bundle-action-btn secondary" onclick="proceedIndividual()">
                        <span>💳</span>
                        Continue Individual Purchase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-close" onclick="closeLoginModal()">×</div>
            <div class="auth-modal-header">
                <h3 class="auth-modal-title">Welcome to Nachna</h3>
                <p class="auth-modal-subtitle">Enter your mobile number to continue</p>
            </div>
            <div class="auth-modal-body">
                <form id="login-form" onsubmit="handleSendOTP(event)">
                    <div class="form-group">
                        <label for="mobile-number" class="form-label">Mobile Number</label>
                        <div class="phone-input-container">
                            <span class="country-code">+91</span>
                            <input
                                type="tel"
                                id="mobile-number"
                                class="form-input"
                                placeholder="Enter your mobile number"
                                maxlength="10"
                                pattern="[0-9]{10}"
                                required
                            >
                        </div>
                    </div>
                    <button type="submit" id="send-otp-btn" class="auth-primary-btn">
                        <span class="btn-text">Send OTP</span>
                        <div class="btn-loader" style="display: none;"></div>
                    </button>
                </form>
                <div id="login-error" class="auth-error" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- OTP Modal -->
    <div id="otp-modal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-close" onclick="closeOTPModal()">×</div>
            <div class="auth-modal-header">
                <h3 class="auth-modal-title">Verify Your Number</h3>
                <p class="auth-modal-subtitle">Enter the 6-digit code sent to <span id="otp-mobile-number"></span></p>
            </div>
            <div class="auth-modal-body">
                <form id="otp-form" onsubmit="handleVerifyOTP(event)">
                    <div class="otp-input-container">
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                    </div>
                    <div class="otp-actions">
                        <button type="button" id="resend-otp-btn" class="auth-secondary-btn" onclick="resendOTP()" disabled>
                            <span class="resend-text">Resend OTP</span>
                            <span class="countdown-text">Resend in 30s</span>
                        </button>
                    </div>
                    <button type="submit" id="verify-otp-btn" class="auth-primary-btn">
                        <span class="btn-text">Verify & Login</span>
                        <div class="btn-loader" style="display: none;"></div>
                    </button>
                </form>
                <div id="otp-error" class="auth-error" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-close" onclick="closeProfileModal()">×</div>
            <div class="profile-modal-header">
                <h3 class="profile-modal-title">Profile</h3>
            </div>
            <div class="profile-modal-body">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar-large">
                        <div id="profile-avatar-container"></div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-name" id="profile-name">Loading...</div>
                        <div class="profile-mobile" id="profile-mobile">Loading...</div>
                        <div class="profile-status" id="profile-status">
                            <span class="status-badge">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Profile Actions -->
                <div class="profile-actions">
                    <button class="profile-action-btn" onclick="openOrdersModal()">
                        <div class="action-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">View all Orders</div>
                            <div class="action-subtitle">Manage your bookings</div>
                        </div>
                        <div class="action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </div>
                    </button>

                    <button class="profile-action-btn" onclick="openRewardsModal()">
                        <div class="action-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">View Rewards Centre</div>
                            <div class="action-subtitle">Earn points & save</div>
                        </div>
                        <div class="action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </div>
                    </button>

                    <button class="profile-action-btn edit-profile" onclick="navigateToEditProfile()">
                        <div class="action-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </div>
                        <div class="action-text">
                            <div class="action-title">Edit Profile</div>
                            <div class="action-subtitle">Update your information</div>
                        </div>
                        <div class="action-arrow">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </div>
                    </button>
                </div>

                <!-- Logout Button -->
                <div class="profile-footer">
                    <button class="logout-btn" onclick="logout()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16,17 21,12 16,7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Modal -->
    <div id="orders-modal" class="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-close" onclick="closeOrdersModal()">×</div>
            <div class="profile-modal-header">
                <div class="orders-header">
                    <h3 class="profile-modal-title">My Orders</h3>
                    <button class="refresh-btn" onclick="refreshOrders()" id="orders-refresh-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                </div>

                <!-- Filter Chips -->
                <div class="filter-chips" id="orders-filter-chips">
                    <button class="filter-chip active" onclick="applyOrderFilter('all')">All Orders</button>
                    <button class="filter-chip" onclick="applyOrderFilter('pending')">Pending</button>
                    <button class="filter-chip" onclick="applyOrderFilter('completed')">Completed</button>
                    <button class="filter-chip" onclick="applyOrderFilter('failed')">Failed</button>
                </div>
            </div>

            <div class="profile-modal-body">
                <div id="orders-loading" class="orders-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading orders...</p>
                </div>
                <div id="orders-error" class="orders-error" style="display: none;">
                    <p>Failed to load orders. <button onclick="refreshOrders()">Try Again</button></p>
                </div>
                <div id="orders-empty" class="orders-empty" style="display: none;">
                    <p>No orders found</p>
                </div>
                <div id="orders-list" class="orders-list"></div>
            </div>
        </div>
    </div>

    <!-- Rewards Modal -->
    <div id="rewards-modal" class="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-close" onclick="closeRewardsModal()">×</div>
            <div class="profile-modal-header">
                <div class="rewards-header">
                    <h3 class="profile-modal-title">Rewards Center</h3>
                    <button class="refresh-btn" onclick="refreshRewards()" id="rewards-refresh-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="profile-modal-body">
                <div id="rewards-loading" class="rewards-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading rewards...</p>
                </div>
                <div id="rewards-error" class="rewards-error" style="display: none;">
                    <p>Failed to load rewards. <button onclick="refreshRewards()">Try Again</button></p>
                </div>

                <!-- Balance Overview -->
                <div id="rewards-balance" class="rewards-balance" style="display: none;">
                    <div class="balance-card">
                        <div class="balance-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="5" width="20" height="14" rx="2" ry="2"/>
                                <line x1="2" y1="10" x2="22" y2="10"/>
                            </svg>
                        </div>
                        <div class="balance-info">
                            <div class="balance-label">Available Balance</div>
                            <div class="balance-amount" id="available-balance">₹0</div>
                        </div>
                    </div>

                    <div class="balance-stats">
                        <div class="stat-card">
                            <div class="stat-icon earned">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                    <polyline points="17 6 23 6 23 12"/>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-label">Earned</div>
                                <div class="stat-value" id="earned-amount">₹0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon redeemed">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="12" r="1"/>
                                    <circle cx="15" cy="12" r="1"/>
                                    <path d="M12 2l3 3-3 3-3-3 3-3z"/>
                                    <path d="M12 22l3-3-3-3-3 3 3 3z"/>
                                </svg>
                            </div>
                            <div class="stat-info">
                                <div class="stat-label">Redeemed</div>
                                <div class="stat-value" id="redeemed-amount">₹0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="rewards-transactions">
                    <div class="transactions-header">
                        <h4>Transaction History</h4>
                        <div class="transaction-tabs">
                            <button class="transaction-tab active" onclick="switchTransactionTab('all')">All</button>
                            <button class="transaction-tab" onclick="switchTransactionTab('credit')">Earned</button>
                            <button class="transaction-tab" onclick="switchTransactionTab('debit')">Redeemed</button>
                        </div>
                    </div>
                    <div id="transactions-list" class="transactions-list"></div>
                    <div id="load-more-btn" class="load-more-btn" style="display: none;">
                        <button onclick="loadMoreTransactions()">Load More</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="qr-modal">
        <div class="qr-modal-content">
            <div class="qr-modal-close" onclick="closeQRModal()">×</div>
            <div class="qr-modal-header">
                <h3 class="qr-modal-title">Workshop QR Code</h3>
                <div class="qr-workshop-info" id="qr-workshop-info">
                    <div class="qr-workshop-title" id="qr-workshop-title">Loading...</div>
                    <div class="qr-workshop-details" id="qr-workshop-details">Loading...</div>
                </div>
            </div>
            <div class="qr-modal-body">
                <div id="qr-loading" class="qr-loading">
                    <div class="loading-spinner"></div>
                    <p>Generating QR Code...</p>
                </div>
                <div id="qr-error" class="qr-error" style="display: none;">
                    <p>Failed to generate QR code</p>
                </div>
                <div id="qr-code-container" class="qr-code-container" style="display: none;">
                    <div id="qr-code-display" class="qr-code-display"></div>
                    <div class="qr-actions">
                        <button class="qr-action-btn download-btn" onclick="downloadQRCode()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span>Download</span>
                        </button>
                        <button class="qr-action-btn share-btn" onclick="shareQRCode()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <path d="m8.59 13.51 6.83 3.98"/>
                                <path d="m15.41 6.51-6.82 3.98"/>
                            </svg>
                            <span>Share</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let studioData = null;
        let workshopsData = null;
        const studioId = "{{ studio_id }}";

        // Authentication variables
        let currentUser = null;
        let authToken = null;
        let otpTimer = null;
        let resendCountdown = 30;
        let currentMobileNumber = '';

        // Profile modal variables
        let currentProfileTab = 'profile';
        let ordersData = null;
        let rewardsData = null;
        let currentOrderFilter = 'all';
        let currentTransactionFilter = 'all';
        let ordersPage = 0;
        let transactionsPage = 1;
        let hasMoreOrders = true;
        let hasMoreTransactions = true;
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContainer = document.getElementById('main-container');
        const studioImage = document.getElementById('studio-image');
        const studioImageFallback = document.getElementById('studio-image-fallback');
        const studioName = document.getElementById('studio-name');
        const studioInstagramIcon = document.getElementById('studio-instagram-icon');
        const thisWeekSection = document.getElementById('this-week-section');
        const upcomingSection = document.getElementById('upcoming-section');
        const thisWeekContent = document.getElementById('this-week-content');
        const upcomingContent = document.getElementById('upcoming-content');
        const emptyState = document.getElementById('empty-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const shareModal = document.getElementById('share-modal');

        // Auth DOM Elements
        const authContainer = document.getElementById('auth-container');
        const authButton = document.getElementById('auth-button');
        const profileModal = document.getElementById('profile-modal');
        const loginModal = document.getElementById('login-modal');
        const otpModal = document.getElementById('otp-modal');
        const mobileInput = document.getElementById('mobile-number');
        const otpMobileNumber = document.getElementById('otp-mobile-number');
        const otpInputs = document.querySelectorAll('.otp-input');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const resendOtpBtn = document.getElementById('resend-otp-btn');
        const loginError = document.getElementById('login-error');
        const otpError = document.getElementById('otp-error');

        // Profile Modal Elements
        const profileAvatarContainer = document.getElementById('profile-avatar-container');
        const profileName = document.getElementById('profile-name');
        const profileMobile = document.getElementById('profile-mobile');
        const profileStatus = document.getElementById('profile-status');
        
        // Utility functions
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(word => word.charAt(0).toUpperCase()).join('').slice(0, 2);
        }
        
        // Centralized image loading function for both artists and studios
        function loadImage(options) {
            const {
                element,           // Image element to load into
                type,             // 'artist' or 'studio'
                entityId,         // Artist ID or Studio ID
                altText,          // Alt text for image
                onSuccess,        // Callback when image loads successfully
                onError,          // Callback when image fails to load
                fallbackElement   // Optional fallback element to show on error
            } = options;
            
            // Validate required parameters
            if (!element || !type || !entityId) {
                if (onError) onError(element);
                return;
            }
            
            // Validate image type
            if (!['artist', 'studio', 'user'].includes(type)) {
                if (onError) onError(element);
                return;
            }
            
            // Force the browser to make a new request
            const timestamp = new Date().getTime();
            const imageUrl = `/api/image/${type}/${entityId}?t=${timestamp}`;
            
            // Create a new image to test loading first
            const testImg = new Image();
            
            testImg.onload = function() {
                // Clear any existing handlers
                element.onload = null;
                element.onerror = null;
                
                // Set up success handler for display element
                element.onload = function() {
                    if (onSuccess) {
                        onSuccess(this);
                    } else {
                        this.style.display = 'block';
                        if (fallbackElement) {
                            fallbackElement.style.display = 'none';
                        }
                    }
                };
                
                // Set up error handler for display element
                element.onerror = function() {
                    if (onError) {
                        onError(this);
                    } else {
                        this.style.display = 'none';
                        if (fallbackElement) {
                            fallbackElement.style.display = 'flex';
                        }
                    }
                };
                
                // Set the source on the actual element
                element.alt = altText || `${type} image`;
                element.src = imageUrl;
                
                // Fallback: If the display element doesn't fire onload within 2 seconds, 
                // assume it loaded and call success manually
                setTimeout(function() {
                    if (element.src === imageUrl && element.naturalWidth > 0) {
                        if (onSuccess) {
                            onSuccess(element);
                        } else {
                            element.style.display = 'block';
                            if (fallbackElement) {
                                fallbackElement.style.display = 'none';
                            }
                        }
                    }
                }, 2000);
            };
            
            testImg.onerror = function() {
                if (onError) {
                    onError(element);
                } else {
                    element.style.display = 'none';
                    if (fallbackElement) {
                        fallbackElement.style.display = 'flex';
                    }
                }
            };
            
            // Start loading the test image
            testImg.src = imageUrl;
        }
        
        function formatTime(timeStr) {
            if (!timeStr) return 'TBA';
            return timeStr;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'TBA';
            return dateStr;
        }
        
        function showLoading() {
            loadingOverlay.style.display = 'flex';
            mainContainer.style.display = 'none';
        }
        
        function hideLoading() {
            loadingOverlay.style.display = 'none';
            mainContainer.style.display = 'block';
            
            // Additional safety check - ensure studio image is loaded after UI is visible
            if (studioData && studioImage.src === '') {
                setTimeout(function() {
                    loadStudioImageDirect();
                }, 200);
            }
        }
        
        function showError(message) {
            hideLoading();
            errorMessage.textContent = message;
            errorState.style.display = 'block';
            thisWeekSection.style.display = 'none';
            upcomingSection.style.display = 'none';
            emptyState.style.display = 'none';
        }
        
        function showEmpty() {
            hideLoading();
            emptyState.style.display = 'block';
            thisWeekSection.style.display = 'none';
            upcomingSection.style.display = 'none';
            errorState.style.display = 'none';
        }
        
        // Load studio image using centralized image loader
        function loadStudioImageDirect() {
            // Validate studio ID
            if (!studioId || !studioId.trim()) {
                showImageFallback();
                return;
            }
            
            // Ensure elements exist
            if (!studioImage || !studioImageFallback) {
                return;
            }
            
            // Use centralized image loading function
            loadImage({
                element: studioImage,
                type: 'studio',
                entityId: studioId,
                altText: studioData?.name || 'Studio Image',
                onSuccess: function(img) {
                    showStudioImage();
                },
                onError: function(img) {
                    showImageFallback();
                },
                fallbackElement: studioImageFallback
            });
        }

        // Load studio data
        async function loadStudioData() {
            try {
                // First try to get all studios and find the specific one
                const studiosResponse = await fetch(`/api/studios`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!studiosResponse.ok) {
                    throw new Error(`Failed to load studios (${studiosResponse.status})`);
                }
                
                const allStudios = await studiosResponse.json();
                studioData = allStudios.find(studio => studio.id === studioId);
                
                if (!studioData) {
                    throw new Error(`Studio with ID ${studioId} not found`);
                }
                
                displayStudioInfo();
            } catch (error) {
                throw error;
            }
        }
        
        // Load workshops data
        async function loadWorkshopsData() {
            try {
                const response = await fetch(`/api/workshops_by_studio/${studioId}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (!response.ok) {
                    throw new Error(`Failed to load workshops (${response.status})`);
                }
                workshopsData = await response.json();
                displayWorkshops();
            } catch (error) {
                throw error;
            }
        }
        
        // Display studio information
        function displayStudioInfo() {
            if (!studioData) {
                return;
            }
            
            // Update studio name and page title
            studioName.textContent = toTitleCase(studioData.name);
            document.title = `${toTitleCase(studioData.name)} - Dance Workshops | Nachna`;
            
            // Handle Instagram icon
            if (studioData.instagram_link) {
                studioInstagramIcon.style.display = 'flex';
                studioInstagramIcon.onclick = function() {
                    window.open(studioData.instagram_link, '_blank', 'noopener,noreferrer');
                };
            } else {
                studioInstagramIcon.style.display = 'none';
            }
            
            // Load studio image with a small delay to ensure DOM is ready
            setTimeout(function() {
                loadStudioImageDirect();
            }, 100);
        }
        
        
        // Show the studio image and hide fallback
        function showStudioImage() {
            studioImage.style.display = 'block';
            studioImageFallback.style.display = 'none';
        }
        
        // Show the fallback icon and hide image
        function showImageFallback() {
            studioImage.style.display = 'none';
            studioImageFallback.style.display = 'flex';
        }
        
        // Create artist avatars using centralized image API
        function createArtistAvatars(workshop) {
            const artistIds = workshop.artist_id_list || [];
            const validArtistIds = artistIds.filter(id => id && id.trim());
            
            if (validArtistIds.length <= 1) {
                // Single avatar
                const container = document.createElement('div');
                container.className = 'artist-avatars';
                
                if (validArtistIds.length === 1) {
                    const img = document.createElement('img');
                    img.className = 'single-avatar';
                    img.style.cursor = 'pointer';
                    img.title = `View ${workshop.by || 'Artist'} details`;
                    
                    // Add click handler to navigate to artist page
                    img.onclick = function(e) {
                        e.stopPropagation(); // Prevent workshop card click
                        trackArtistClick(validArtistIds[0], workshop);
                        window.open(`/web/artist/${validArtistIds[0]}`, '_blank');
                    };
                    
                    // Use centralized image loading function
                    loadImage({
                        element: img,
                        type: 'artist',
                        entityId: validArtistIds[0],
                        altText: workshop.by || 'Artist',
                        onError: function(imgElement) {
                            // Show initials fallback on error
                            const fallback = document.createElement('div');
                            fallback.className = 'avatar-fallback';
                            fallback.style.cursor = 'pointer';
                            fallback.title = `View ${workshop.by || 'Artist'} details`;
                            fallback.textContent = getInitials(workshop.by);
                            
                            // Add click handler to fallback as well
                            fallback.onclick = function(e) {
                                e.stopPropagation(); // Prevent workshop card click
                                trackArtistClick(validArtistIds[0], workshop);
                                window.open(`/web/artist/${validArtistIds[0]}`, '_blank');
                            };
                            
                            container.replaceChild(fallback, imgElement);
                        }
                    });
                    
                    container.appendChild(img);
                } else {
                    const fallback = document.createElement('div');
                    fallback.className = 'avatar-fallback';
                    fallback.textContent = getInitials(workshop.by);
                    container.appendChild(fallback);
                }
                
                return container;
            } else {
                // Multiple avatars
                const container = document.createElement('div');
                container.className = 'artist-avatars';
                
                const multipleContainer = document.createElement('div');
                multipleContainer.className = 'multiple-avatars';
                multipleContainer.style.cursor = 'pointer';
                multipleContainer.title = 'View artist details';
                
                // Add click handler for multiple avatars - show selection modal
                multipleContainer.onclick = function(e) {
                    e.stopPropagation(); // Prevent workshop card click
                    showArtistSelectionModal(validArtistIds, workshop);
                };
                
                const maxAvatars = Math.min(validArtistIds.length, 3);
                for (let i = 0; i < maxAvatars; i++) {
                    const img = document.createElement('img');
                    img.className = 'avatar-stack';
                    
                    // Use centralized image loading function
                    loadImage({
                        element: img,
                        type: 'artist',
                        entityId: validArtistIds[i],
                        altText: `Artist ${i + 1}`,
                        onError: function(imgElement) {
                            // Show initials fallback on error
                            const fallback = document.createElement('div');
                            fallback.className = 'avatar-stack avatar-fallback';
                            fallback.style.width = '36px';
                            fallback.style.height = '36px';
                            fallback.style.fontSize = '0.8rem';
                            fallback.textContent = getInitials(workshop.by);
                            multipleContainer.replaceChild(fallback, imgElement);
                        }
                    });
                    
                    multipleContainer.appendChild(img);
                }
                
                // Show count if more than 3 artists
                if (validArtistIds.length > 3) {
                    const countDiv = document.createElement('div');
                    countDiv.className = 'avatar-count';
                    countDiv.textContent = `+${validArtistIds.length - 2}`;
                    multipleContainer.appendChild(countDiv);
                }
                
                container.appendChild(multipleContainer);
                return container;
            }
        }
        
        // Create workshop card
        function createWorkshopCard(workshop) {
            const card = document.createElement('div');
            card.className = 'workshop-card';
            
             // Header: Artist name with Instagram icon and date badge
             const header = document.createElement('div');
             header.className = 'workshop-header';
             
             // Artist name container (artist name + Instagram icon)
             const artistContainer = document.createElement('div');
             artistContainer.className = 'artist-name-container';
             
             const artistName = document.createElement('div');
             artistName.className = 'workshop-artist-name';
             artistName.textContent = toTitleCase(workshop.by || 'Dance Workshop');
             artistContainer.appendChild(artistName);
             
             // Add Instagram icon beside artist name if available
             const artistInstagramLinks = workshop.artist_instagram_links || [];
             const validInstagramLinks = artistInstagramLinks.filter(link => link && link.trim());
             
             if (validInstagramLinks.length > 0) {
                 const instagramIcon = document.createElement('div');
                 instagramIcon.className = 'artist-name-instagram-icon';
                 instagramIcon.title = 'View artist on Instagram';
                 instagramIcon.onclick = function() {
                     if (validInstagramLinks.length === 1) {
                         trackArtistInstagramClick(validInstagramLinks[0], workshop);
                         window.open(validInstagramLinks[0], '_blank', 'noopener,noreferrer');
                     } else {
                         showArtistInstagramModal(validInstagramLinks, workshop);
                     }
                 };
                 instagramIcon.innerHTML = `
                     <svg viewBox="0 0 24 24">
                         <defs>
                             <linearGradient id="instagram-gradient-header-${Date.now()}" x1="0%" y1="0%" x2="100%" y2="100%">
                                 <stop offset="0%" style="stop-color:#833AB4"/>
                                 <stop offset="50%" style="stop-color:#E4405F"/>
                                 <stop offset="100%" style="stop-color:#F77737"/>
                             </linearGradient>
                         </defs>
                         <path fill="url(#instagram-gradient-header-${Date.now()})" d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8A1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5a5 5 0 0 1-5 5a5 5 0 0 1-5-5a5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3z"/>
                     </svg>
                 `;
                 artistContainer.appendChild(instagramIcon);
             }
             
             const dateBadge = document.createElement('div');
             dateBadge.className = 'workshop-date-badge';
             dateBadge.textContent = formatDate(workshop.date);
             
             header.appendChild(artistContainer);
             header.appendChild(dateBadge);
            
            card.appendChild(header);
            
            // Content row: Avatar + Details + Action buttons
            const content = document.createElement('div');
            content.className = 'workshop-content';
            
            // Artist avatar
            const avatars = createArtistAvatars(workshop);
            content.appendChild(avatars);
            
            // Workshop details column
            const detailsColumn = document.createElement('div');
            detailsColumn.className = 'workshop-details-column';
            
            // Song name (if available) - positioned beside avatar
            if (workshop.song && workshop.song.trim() && workshop.song !== 'TBA') {
                const songRow = document.createElement('div');
                songRow.className = 'workshop-song-row';
                songRow.textContent = toTitleCase(workshop.song);
                detailsColumn.appendChild(songRow);
            }
            
            // Pricing info with icon
            const pricingRow = document.createElement('div');
            pricingRow.className = 'workshop-detail-row';

            // Format pricing with rupee symbol
            let pricingText = 'Price TBA';
            if (workshop.pricing_info && workshop.pricing_info !== 'TBA') {
                // Add rupee symbol if not already present
                let price = workshop.pricing_info.trim();
                price = price.startsWith('₹') ? price : `₹${price}`;

                // Replace \n and actual newlines with <br> tags for proper formatting
                pricingText = price.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
            }

            pricingRow.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(255,255,255,0.7)">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span class="workshop-detail-text">${pricingText}</span>
            `;
            detailsColumn.appendChild(pricingRow);
            
            // Time info with icon
            const timeRow = document.createElement('div');
            timeRow.className = 'workshop-detail-row';
            timeRow.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(255,255,255,0.7)">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 6L12 10.5 9.5 8 11 6.5 12 7.5 13 6.5 14.5 8z"/>
                </svg>
                <span class="workshop-detail-text">${formatTime(workshop.time) || '6 PM'}</span>
            `;
            detailsColumn.appendChild(timeRow);
            
            content.appendChild(detailsColumn);
            
             // Action buttons container (now only for other buttons if needed)
             const actionButtons = document.createElement('div');
             actionButtons.className = 'action-buttons';
             
             // Only add action buttons if there are any other actions needed
             if (actionButtons.children.length > 0) {
                 content.appendChild(actionButtons);
             }
            
            // Register button (takes remaining space)
            const registerBtn = document.createElement('button');
            if (workshop.payment_link && workshop.payment_link.trim()) {
                const linkType = workshop.payment_link_type?.toLowerCase() || 'external';
                registerBtn.className = `register-button ${linkType}`;
                registerBtn.textContent = linkType === 'nachna' ? 'Register with nachna' : linkType === 'whatsapp' ? 'Register via WhatsApp' : 'Register';

                registerBtn.onclick = function() {
                    trackWorkshopClick(workshop);

                    if (linkType === 'whatsapp') {
                        // Handle WhatsApp registration
                        handleWhatsAppRegistration(workshop);
                    } else if (linkType === 'nachna') {
                        // Handle Nachna payment link creation
                        handleNachnaRegistration(workshop, registerBtn);
                    } else {
                        // Handle external registration links
                        window.open(workshop.payment_link, '_blank', 'noopener,noreferrer');
                    }
                };
            } else {
                registerBtn.className = 'register-button disabled';
                registerBtn.textContent = 'Register';
                registerBtn.disabled = true;
            }
            
            content.appendChild(registerBtn);

            card.appendChild(content);

            // Add data attributes for bundle suggestion modal to find this workshop
            card.dataset.uuid = workshop.uuid;
            card.dataset.song = workshop.song || '';
            card.dataset.artist = workshop.by || '';
            card.dataset.date = workshop.date || '';
            card.dataset.time = workshop.time || '';
            card.dataset.pricing = workshop.pricing_info || '';
            card.dataset.paymentLink = workshop.payment_link || '';
            card.dataset.paymentLinkType = workshop.payment_link_type || '';
            card.dataset.studioId = workshop.studio_id || '';
            return card;
        }
        
        // Display workshops
        function displayWorkshops() {
            if (!workshopsData) return;

            // Store workshops data globally for bundle suggestion modal
            window.currentWorkshops = [];
            window.futureWorkshops = [];

            // Flatten current workshops (this week)
            if (workshopsData.this_week) {
                workshopsData.this_week.forEach(daySchedule => {
                    if (daySchedule.workshops) {
                        window.currentWorkshops.push(...daySchedule.workshops);
                    }
                });
            }

            // Store future workshops
            if (workshopsData.post_this_week) {
                window.futureWorkshops = workshopsData.post_this_week;
            }

            console.log('Stored workshops globally:', {
                current: window.currentWorkshops.length,
                future: window.futureWorkshops.length
            });

            const hasThisWeek = workshopsData.this_week && workshopsData.this_week.length > 0;
            const hasUpcoming = workshopsData.post_this_week && workshopsData.post_this_week.length > 0;
            
            if (!hasThisWeek && !hasUpcoming) {
                showEmpty();
                return;
            }
            
            hideLoading();
            errorState.style.display = 'none';
            emptyState.style.display = 'none';
            
            // Display this week workshops
            if (hasThisWeek) {
                thisWeekSection.style.display = 'block';
                thisWeekContent.innerHTML = '';
                
                workshopsData.this_week.forEach(daySchedule => {
                    const daySection = document.createElement('div');
                    daySection.className = 'day-section';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = daySchedule.day;
                    daySection.appendChild(dayHeader);
                    
                    const workshopsGrid = document.createElement('div');
                    workshopsGrid.className = 'workshops-grid';
                    
                    daySchedule.workshops.forEach(workshop => {
                        const workshopCard = createWorkshopCard(workshop);
                        workshopsGrid.appendChild(workshopCard);
                    });
                    
                    daySection.appendChild(workshopsGrid);
                    thisWeekContent.appendChild(daySection);
                });
            }
            
            // Display upcoming workshops
            if (hasUpcoming) {
                upcomingSection.style.display = 'block';
                upcomingContent.innerHTML = '';
                
                workshopsData.post_this_week.forEach(workshop => {
                    const workshopCard = createWorkshopCard(workshop);
                    upcomingContent.appendChild(workshopCard);
                });
            }
        }
        
        // Handle WhatsApp registration
        function handleWhatsAppRegistration(workshop) {
            try {
                // Check if payment_link contains a phone number (WhatsApp link format)
                let whatsappUrl = '';
                let whatsappBizUrl = '';
                let webFallback = '';

                if (workshop.payment_link && workshop.payment_link.includes('wa.me')) {
                    // If it's already a wa.me link, extract phone number and add message
                    const phoneMatch = workshop.payment_link.match(/wa\.me\/(\d+)/);
                    if (phoneMatch) {
                        const phoneNumber = phoneMatch[1];
                        const workshopDetails = buildWhatsAppMessage(workshop);
                        const encodedMessage = encodeURIComponent(workshopDetails);

                        whatsappBizUrl = `whatsapp-business://send?text=${encodedMessage}`;
                        whatsappUrl = `whatsapp://send?text=${encodedMessage}`;
                        webFallback = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    }
                } else {
                    // For phone number format, clean and format it
                    const phoneNumber = workshop.payment_link ? workshop.payment_link.replace(/\D/g, '') : '';
                    if (phoneNumber && phoneNumber.length >= 10) {
                        // Add Indian country code if not present
                        const fullPhoneNumber = phoneNumber.length === 10 ? `91${phoneNumber}` : phoneNumber;
                        const workshopDetails = buildWhatsAppMessage(workshop);
                        const encodedMessage = encodeURIComponent(workshopDetails);

                        whatsappBizUrl = `whatsapp-business://send?text=${encodedMessage}`;
                        whatsappUrl = `whatsapp://send?text=${encodedMessage}`;
                        webFallback = `https://wa.me/${fullPhoneNumber}?text=${encodedMessage}`;
                    }
                }

                if (webFallback) {
                    // If we have a specific phone number, use wa.me with phone number
                    console.log('Using WhatsApp Web with phone number:', webFallback);
                    window.open(webFallback, '_blank', 'noopener,noreferrer');
                } else if (whatsappBizUrl) {
                    // Try WhatsApp Business first (general message, user chooses recipient)
                    console.log('Trying WhatsApp Business:', whatsappBizUrl);
                    const whatsappWindow = window.open(whatsappBizUrl, '_blank', 'noopener,noreferrer');

                    // Check if WhatsApp Business opened, fallback to regular WhatsApp
                    setTimeout(() => {
                        if (!whatsappWindow || whatsappWindow.closed) {
                            console.log('WhatsApp Business not available, trying regular WhatsApp');
                            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                        }
                    }, 1000);
                } else {
                    // Fallback to original payment link
                    console.log('Using original payment link:', workshop.payment_link);
                    window.open(workshop.payment_link, '_blank', 'noopener,noreferrer');
                }

            } catch (error) {
                console.error('Error opening WhatsApp:', error);
                // Fallback to regular link
                window.open(workshop.payment_link, '_blank', 'noopener,noreferrer');
            }
        }

        // Build WhatsApp message with workshop details
        function buildWhatsAppMessage(workshop) {
            if (!workshop) {
                return "Hi! I'm interested in registering for your dance workshop. Could you please share the registration details?";
            }

            let message = "Hi! I'm interested in registering for the following dance workshop:\n\n";

            // Add workshop details with proper formatting
            if (workshop.song && workshop.song.trim() && workshop.song !== 'TBA') {
                message += `🎵 Song: ${toTitleCase(workshop.song)}\n`;
            }

            if (workshop.by && workshop.by.trim() && workshop.by !== 'TBA') {
                message += `💃 Artist: ${toTitleCase(workshop.by)}\n`;
            }

            if (studioData && studioData.name) {
                message += `🏢 Studio: ${toTitleCase(studioData.name)}\n`;
            }

            if (workshop.date) {
                message += `📅 Date: ${formatDate(workshop.date)}\n`;
            }

            if (workshop.time) {
                message += `⏰ Time: ${formatTime(workshop.time)}\n`;
            }

            message += "\nCould you please help me with the registration process? Thank you! 🙏";

            return message;
        }

        // Handle Nachna payment link creation
        async function handleNachnaRegistration(workshop, button) {
            try {
                // Check if user is logged in
                if (!authToken || !currentUser) {
                    alert('Please login to register with nachna.');
                    openLoginModal();
                    return;
                }

                // Show loading state
                const originalText = button.textContent;
                button.textContent = 'Checking bundles...';
                button.disabled = true;
                button.setAttribute('data-original-text', originalText);

                // Store current workshop for later use
                currentWorkshopUuid = workshop.uuid;
                currentWorkshop = workshop;

                // Create workshop identifier (must be UUID format)
                const workshopIdentifier = workshop.uuid;

                if (!workshopIdentifier) {
                    throw new Error('Workshop UUID is required for bundle checking');
                }

                // First, check if there are available bundles for this workshop
                console.log(`Checking bundles for workshop ${workshopIdentifier}`);

                const bundleResponse = await fetch(`/api/orders/bundles/check/${workshopIdentifier}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!bundleResponse.ok) {
                    // If bundle check fails, proceed with individual purchase
                    console.warn('Bundle check failed, proceeding with individual purchase');
                    await proceedIndividualPurchase(workshop, button);
                    return;
                }

                const bundleData = await bundleResponse.json();

                if (bundleData.bundles_available && bundleData.bundles && bundleData.bundles.length > 0) {
                    // Show bundle selection modal
                    console.log(`Found ${bundleData.bundles.length} bundle(s) containing workshop ${workshopIdentifier}:`, bundleData.bundles);
                    showBundleSelectionModal(workshop, bundleData.bundles, button);
                } else {
                    // No bundles available for this workshop, proceed with individual purchase
                    console.log(`No bundles found containing workshop ${workshopIdentifier}, proceeding with individual purchase`);
                    await proceedIndividualPurchase(workshop, button);
                }

            } catch (error) {
                console.error('Error in Nachna registration flow:', error);

                // Show error message
                const errorMessage = error.message || 'Failed to process registration. Please try again.';
                showError(errorMessage);

                // Fallback to direct link if available
                if (workshop.payment_link) {
                    console.log('Using fallback payment link:', workshop.payment_link);
                    setTimeout(() => {
                        try {
                            window.open(workshop.payment_link, '_blank', 'noopener,noreferrer');
                        } catch (fallbackError) {
                            console.error('Fallback link also failed:', fallbackError);
                        }
                    }, 2000);
                }
            } finally {
                // Reset button state if not already reset
                if (button.disabled) {
                    button.textContent = button.getAttribute('data-original-text') || 'Register with nachna';
                    button.disabled = false;
                }
            }
        }

        async function proceedIndividualPurchase(workshop, button) {
            try {
                // Update button text
                button.textContent = 'Creating payment link...';

                // Create workshop identifier (must be UUID format)
                const workshopIdentifier = workshop.uuid;

                if (!workshopIdentifier) {
                    throw new Error('Workshop UUID is required for payment link creation');
                }

                // Create individual payment link via API
                const response = await fetch('/api/orders/create-payment-link', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        workshop_uuid: workshopIdentifier,
                        points_redeemed: 0.0,
                        discount_amount: 0.0
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment link');
                }

                const result = await response.json();
                console.log('Individual payment link API response:', result);

                if (result.payment_link_url) {
                    // Try to open payment link in new tab
                    const paymentWindow = window.open(result.payment_link_url, '_blank', 'noopener,noreferrer');

                    // Check if popup was blocked (after a short delay to allow window to open)
                    setTimeout(() => {
                        if (!paymentWindow || paymentWindow.closed || typeof paymentWindow.closed === 'undefined') {
                            // Popup was blocked - show helpful message
                            showPaymentLinkModal(result.payment_link_url, result.order_id);
                        } else {
                            // Popup opened successfully - send analytics
                            if (typeof gtag !== 'undefined') {
                                gtag('event', 'nachna_payment_created', {
                                    workshop_id: workshop.uuid,
                                    workshop_identifier: workshopIdentifier,
                                    song_name: workshop.song,
                                    artist_name: workshop.by,
                                    studio_id: studioId,
                                    studio_name: studioData?.name,
                                    purchase_type: 'individual'
                                });
                            }
                        }
                    }, 100);

                } else {
                    console.error('No payment_link_url in response:', result);
                    throw new Error(result.error || result.message || 'Payment link URL not found in response');
                }

            } catch (error) {
                console.error('Error creating individual payment link:', error);
                throw error; // Re-throw to be handled by caller
            }
        }

        // Show payment link modal when popups are blocked
        function showPaymentLinkModal(paymentUrl, orderId) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'payment-link-modal-overlay';
            modal.innerHTML = `
                <div class="payment-link-modal">
                    <div class="modal-header">
                        <h3>Payment Link Ready</h3>
                        <button class="modal-close" onclick="this.closest('.payment-link-modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <p>Your payment link has been created successfully!</p>
                        <div class="order-info">
                            <strong>Order ID:</strong> ${orderId || 'N/A'}
                        </div>
                        <div class="payment-actions">
                            <button class="action-btn primary" onclick="openPaymentLink('${paymentUrl}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15,3 21,3 21,9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                Open Payment Link
                            </button>
                            <button class="action-btn secondary" onclick="copyPaymentLink('${paymentUrl}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                                Copy Link
                            </button>
                        </div>
                        <div class="modal-note">
                            <small>💡 Tip: Allow popups for this site to open payment links automatically</small>
                        </div>
                    </div>
                </div>
            `;

            // Add modal styles
            const style = document.createElement('style');
            style.textContent = `
                .payment-link-modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    backdrop-filter: blur(5px);
                }
                .payment-link-modal {
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 20px;
                    padding: 0;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 24px;
                    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                    background: linear-gradient(135deg, #00D4FF, #9C27B0);
                    color: white;
                    border-radius: 20px 20px 0 0;
                }
                .modal-header h3 {
                    margin: 0;
                    font-size: 1.2rem;
                    font-weight: 600;
                }
                .modal-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 0;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: background 0.2s;
                }
                .modal-close:hover {
                    background: rgba(255, 255, 255, 0.2);
                }
                .modal-body {
                    padding: 24px;
                }
                .order-info {
                    background: rgba(0, 214, 255, 0.1);
                    padding: 12px 16px;
                    border-radius: 12px;
                    margin: 16px 0;
                    border: 1px solid rgba(0, 214, 255, 0.2);
                }
                .payment-actions {
                    display: flex;
                    gap: 12px;
                    margin: 20px 0;
                }
                .action-btn {
                    flex: 1;
                    padding: 12px 16px;
                    border: none;
                    border-radius: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    font-size: 14px;
                }
                .action-btn.primary {
                    background: linear-gradient(135deg, #00D4FF, #9C27B0);
                    color: white;
                }
                .action-btn.primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
                }
                .action-btn.secondary {
                    background: rgba(0, 0, 0, 0.05);
                    color: #333;
                    border: 1px solid rgba(0, 0, 0, 0.1);
                }
                .action-btn.secondary:hover {
                    background: rgba(0, 0, 0, 0.1);
                }
                .modal-note {
                    margin-top: 16px;
                    padding: 12px;
                    background: rgba(255, 193, 7, 0.1);
                    border: 1px solid rgba(255, 193, 7, 0.2);
                    border-radius: 8px;
                    text-align: center;
                }
                .modal-note small {
                    color: #856404;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(modal);

            // Focus management
            modal.querySelector('.modal-close').focus();
        }

        // Helper function to open payment link
        function openPaymentLink(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Function to handle payment for existing orders
        function payOrder(orderId, paymentLinkUrl) {
            try {
                console.log('Opening payment link for order:', orderId, paymentLinkUrl);

                // Try to open payment link in new window
                const paymentWindow = window.open(paymentLinkUrl, '_blank', 'noopener,noreferrer');

                // Check if popup was blocked
                setTimeout(() => {
                    if (!paymentWindow || paymentWindow.closed) {
                        // Popup was blocked, show modal instead
                        console.log('Payment popup blocked, showing modal');
                        showPaymentLinkModal(paymentLinkUrl, orderId);
                    }
                }, 100);

            } catch (error) {
                console.error('Error opening payment link:', error);
                // Fallback to modal
                showPaymentLinkModal(paymentLinkUrl, orderId);
            }
        }

        // Helper function to copy payment link
        async function copyPaymentLink(url) {
            try {
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(url);
                    // Show success feedback
                    const notification = document.createElement('div');
                    notification.textContent = 'Payment link copied to clipboard!';
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10B981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10001;
                        font-weight: 500;
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Payment link copied to clipboard!');
                }
            } catch (error) {
                console.error('Failed to copy link:', error);
                alert('Failed to copy link. Please copy manually: ' + url);
            }
        }

        // Analytics tracking
        function trackWorkshopClick(workshop) {

            // Send analytics event if available
            if (typeof gtag !== 'undefined') {
                gtag('event', 'workshop_book_click', {
                    workshop_id: workshop.uuid,
                    song_name: workshop.song,
                    artist_name: workshop.by,
                    studio_id: studioId,
                    studio_name: studioData?.name
                });
            }
        }
        
        function trackArtistInstagramClick(instagramUrl, workshop) {
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'artist_instagram_click', {
                    instagram_url: instagramUrl,
                    workshop_id: workshop.uuid,
                    artist_name: workshop.by,
                    studio_id: studioId,
                    studio_name: studioData?.name
                });
            }
        }
        
        function trackChoreoClick(choreoUrl, workshop) {
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'choreo_video_click', {
                    choreo_url: choreoUrl,
                    workshop_id: workshop.uuid,
                    song_name: workshop.song,
                    artist_name: workshop.by,
                    studio_id: studioId,
                    studio_name: studioData?.name
                });
            }
        }
        
        function trackArtistClick(artistId, workshop) {
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'artist_profile_click', {
                    artist_id: artistId,
                    workshop_id: workshop.uuid,
                    artist_name: workshop.by,
                    studio_id: studioId,
                    studio_name: studioData?.name
                });
            }
        }
        
        // Share functionality
        function openShareModal() {
            if (!studioData) return;
            
            const shareUrl = window.location.href;
            const shareText = `Check out ${toTitleCase(studioData.name)} on Nachna! 💃🕺\n\nDiscover amazing dance workshops at this studio.\n\nView workshops: ${shareUrl}\n\nDon't have Nachna yet? Download it here:\nhttps://apps.apple.com/in/app/nachna/id6746702742`;
            
            // Update share links
            const whatsappShare = document.getElementById('whatsapp-share');
            const instagramShare = document.getElementById('instagram-share');
            const genericShare = document.getElementById('generic-share');
            
            whatsappShare.href = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
            instagramShare.onclick = function(e) {
                e.preventDefault();
                // Instagram story sharing would require the mobile app
                if (navigator.share) {
                    navigator.share({
                        title: `${toTitleCase(studioData.name)} - Nachna`,
                        text: shareText,
                        url: shareUrl
                    });
                } else {
                    copyToClipboard(shareText);
                }
            };
            genericShare.onclick = function(e) {
                e.preventDefault();
                if (navigator.share) {
                    navigator.share({
                        title: `${toTitleCase(studioData.name)} - Nachna`,
                        text: shareText,
                        url: shareUrl
                    });
                } else {
                    copyToClipboard(shareText);
                }
            };
            
            shareModal.classList.add('show');
        }
        
        function closeShareModal() {
            shareModal.classList.remove('show');
        }

        // Bundle Suggestion Modal Functions
        let currentBundleSuggestion = null;
        let currentWorkshopUuid = null;

        function showBundleSelectionModal(workshop, bundles, button) {
            // Reset button state
            button.textContent = button.getAttribute('data-original-text') || 'Register with nachna';
            button.disabled = false;

            // Create or update bundle selection modal
            let modal = document.getElementById('bundle-selection-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'bundle-selection-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content bundle-modal">
                        <div class="modal-header">
                            <h2>🎯 Choose Your Option</h2>
                            <button class="modal-close" onclick="closeBundleSelectionModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="current-workshop-info">
                                <h3>Selected Workshop</h3>
                                <div class="workshop-summary">
                                    <div class="workshop-title" id="current-workshop-title"></div>
                                    <div class="workshop-details" id="current-workshop-details"></div>
                                </div>
                            </div>

                            <div class="bundle-options" id="bundle-options"></div>

                            <div class="individual-option">
                                <div class="option-card individual-card">
                                    <div class="option-header">
                                        <h4>Individual Workshop</h4>
                                        <div class="price-tag" id="individual-price">₹799</div>
                                    </div>
                                    <div class="option-description">
                                        Purchase only the selected workshop above
                                    </div>
                                    <button class="option-button secondary" onclick="selectIndividualPurchase()">
                                        Continue Individual Purchase
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Populate current workshop info
            document.getElementById('current-workshop-title').textContent =
                workshop.song || workshop.title || 'Workshop';
            document.getElementById('current-workshop-details').textContent =
                `${workshop.by || workshop.instructor || 'Instructor'} • ${workshop.date || ''} ${workshop.time || ''}`;

            // Populate bundle options
            const bundleOptions = document.getElementById('bundle-options');
            bundleOptions.innerHTML = '';

            bundles.forEach((bundle, index) => {
                const bundleCard = document.createElement('div');
                bundleCard.className = 'option-card bundle-card';
                bundleCard.innerHTML = `
                    <div class="option-header">
                        <h4>${bundle.name}</h4>
                        <div class="bundle-badge">Bundle Deal</div>
                    </div>
                    <div class="bundle-description">${bundle.description}</div>
                    <div class="pricing-comparison">
                        <div class="price-row">
                            <span class="price-label">Individual Total:</span>
                            <span class="price-value strikethrough">₹${bundle.individual_total_price}</span>
                        </div>
                        <div class="price-row bundle-price">
                            <span class="price-label">Bundle Price:</span>
                            <span class="price-value highlight">₹${bundle.bundle_price}</span>
                        </div>
                        <div class="savings-badge">
                            Save ₹${bundle.savings_amount} (${bundle.savings_percentage}%)
                        </div>
                    </div>
                    <div class="workshop-count">${bundle.workshop_count} workshops included</div>
                    <button class="option-button primary" onclick="selectBundlePurchase('${bundle.bundle_id}')">
                        Get Bundle & Save ₹${bundle.savings_amount}
                    </button>
                `;
                bundleOptions.appendChild(bundleCard);
            });

            // Set individual price
            const individualPrice = bundles[0]?.individual_total_price / bundles[0]?.workshop_count || 799;
            document.getElementById('individual-price').textContent = `₹${individualPrice}`;

            modal.style.display = 'flex';
        }

        function closeBundleSelectionModal() {
            const modal = document.getElementById('bundle-selection-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function selectBundlePurchase(bundleId) {
            if (!bundleId) {
                alert('Bundle ID is required');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<span>⏳</span> Processing...';
            button.disabled = true;

            // Close modal
            closeBundleSelectionModal();

            // Create bundle payment link (now creates single order with multiple workshops)
            fetch(`/api/orders/bundles/${bundleId}/create-payment-link`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})  // Empty body for now
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.payment_link_url) {
                    // Success - redirect to payment
                    console.log('Single bundle order payment link created:', data.payment_link_url);

                    // Try to open payment link in new tab
                    const paymentWindow = window.open(data.payment_link_url, '_blank', 'noopener,noreferrer');

                    // Check if popup was blocked
                    setTimeout(() => {
                        if (!paymentWindow || paymentWindow.closed || typeof paymentWindow.closed === 'undefined') {
                            // Popup was blocked - show helpful message
                            showPaymentLinkModal(data.payment_link_url, data.order_id);
                        } else {
                            // Send analytics
                            if (typeof gtag !== 'undefined') {
                                gtag('event', 'bundle_purchase_started', {
                                    bundle_id: bundleId,
                                    purchase_type: 'single_bundle_order',
                                    studio_id: studioId,
                                    studio_name: studioData?.name,
                                    order_id: data.order_id
                                });
                            }
                        }
                    }, 100);
                } else {
                    alert('Failed to create bundle payment link: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Bundle purchase failed:', error);
                alert('Bundle purchase failed. Please try again.');
            });
        }

        async function selectIndividualPurchase() {
            // Close modal
            closeBundleSelectionModal();

            // Find the original button that triggered the flow
            const workshopCards = document.querySelectorAll('.workshop-card, .event-item');
            let originalButton = null;

            for (const card of workshopCards) {
                const workshopData = card.dataset;
                if (workshopData.uuid === currentWorkshopUuid) {
                    originalButton = card.querySelector('.register-button.nachna');
                    break;
                }
            }

            if (originalButton) {
                // Use the original button for the individual purchase flow
                await proceedIndividualPurchase(currentWorkshop, originalButton);
            } else {
                // Fallback - create a temporary button for the flow
                const tempButton = document.createElement('button');
                tempButton.textContent = 'Creating payment link...';
                tempButton.disabled = true;
                await proceedIndividualPurchase(currentWorkshop, tempButton);
            }
        }

        function closeBundleSuggestionModal() {
            const modal = document.getElementById('bundle-suggestion-modal');
            modal.style.display = 'none';
            currentBundleSuggestion = null;
            currentWorkshopUuid = null;
        }

        function purchaseBundle() {
            if (!currentBundleSuggestion) {
                alert('No bundle suggestion available');
                return;
            }

            // Check if user is authenticated
            fetch('/api/auth/status', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    // Proceed with bundle purchase
                    proceedWithBundlePurchase(data.user_id, currentBundleSuggestion.bundle_template_id);
                } else {
                    // Redirect to login with bundle intent
                    window.location.href = `/studio?login_required=true&redirect=${encodeURIComponent(window.location.pathname)}&bundle_intent=${currentBundleSuggestion.bundle_template_id}`;
                }
            })
            .catch(error => {
                console.error('Auth check failed:', error);
                alert('Unable to verify authentication. Please try again.');
            });
        }

        function proceedIndividual() {
            // Close bundle suggestion modal
            closeBundleSuggestionModal();

            // Proceed with normal individual purchase flow
            if (currentWorkshopUuid) {
                // Find the workshop and trigger purchase
                const workshop = findWorkshopByUuid(currentWorkshopUuid);
                if (workshop) {
                    handleNachnaRegistration(workshop);
                }
            }
        }

        function proceedWithBundlePurchase(userId, bundleTemplateId) {
            // Show loading state
            const primaryBtn = document.querySelector('.bundle-action-btn.primary');
            const originalText = primaryBtn.innerHTML;
            primaryBtn.innerHTML = '<span>⏳</span> Processing...';
            primaryBtn.disabled = true;

            // Make bundle purchase API call
            fetch('/api/orders/bundles/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    template_id: bundleTemplateId,
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - redirect to payment
                    window.location.href = data.payment_link_url;
                } else {
                    alert('Bundle purchase failed: ' + (data.message || 'Unknown error'));
                    // Reset button
                    primaryBtn.innerHTML = originalText;
                    primaryBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Bundle purchase failed:', error);
                alert('Bundle purchase failed. Please try again.');
                // Reset button
                primaryBtn.innerHTML = originalText;
                primaryBtn.disabled = false;
            });
        }

        function findWorkshopByUuid(uuid) {
            // Helper function to find workshop by UUID
            // This would need to be implemented based on how workshops are stored in the frontend
            // For now, return a placeholder - you'll need to implement this based on your workshop storage
            console.log('Finding workshop by UUID:', uuid);

            // Search through current workshops
            if (window.currentWorkshops && Array.isArray(window.currentWorkshops)) {
                const workshop = window.currentWorkshops.find(w => w.uuid === uuid);
                if (workshop) {
                    console.log('Found workshop:', workshop.song || workshop.title);
                    return workshop;
                }
            }

            // Search through future workshops
            if (window.futureWorkshops && Array.isArray(window.futureWorkshops)) {
                const workshop = window.futureWorkshops.find(w => w.uuid === uuid);
                if (workshop) {
                    console.log('Found workshop:', workshop.song || workshop.title);
                    return workshop;
                }
            }

            // If not found in memory, try to search in the DOM (last resort)
            const workshopElements = document.querySelectorAll('.workshop-card, .event-item');
            for (const element of workshopElements) {
                const workshopData = element.dataset;
                if (workshopData.uuid === uuid) {
                    // Create workshop object from DOM data
                    const workshop = {
                        uuid: workshopData.uuid,
                        song: workshopData.song || workshopData.title,
                        by: workshopData.artist || workshopData.instructor,
                        date: workshopData.date,
                        time: workshopData.time,
                        pricing_info: workshopData.pricing,
                        payment_link: workshopData.paymentLink,
                        payment_link_type: workshopData.paymentLinkType,
                        studio_id: workshopData.studioId
                    };
                    console.log('Found workshop in DOM:', workshop.song);
                    return workshop;
                }
            }

            console.error('Workshop not found with UUID:', uuid);
            return null;
        }
        
        // Artist Instagram modal functionality
        function showArtistInstagramModal(instagramLinks, workshop) {
            const artistNames = (workshop.by || 'Artists').split(' X ');
            
            // Create modal content dynamically
            const modalContent = `
                <div class="share-content">
                    <div class="share-close" onclick="closeArtistInstagramModal()">×</div>
                    <div class="share-header">
                        <h3 class="share-title">Artist Instagram</h3>
                        <p class="share-subtitle">Choose which artist to view on Instagram</p>
                    </div>
                    <div class="share-options" id="artist-instagram-options">
                        ${instagramLinks.map((link, index) => `
                            <a href="${link}" target="_blank" rel="noopener,noreferrer" class="share-option" 
                               onclick="trackArtistInstagramClick('${link}', ${JSON.stringify(workshop).replace(/"/g, '&quot;')}); closeArtistInstagramModal();">
                                <div class="share-option-icon" style="background: linear-gradient(45deg, #E4405F, #833AB4);">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                        <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8a3.6 3.6 0 0 0 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6m9.65 1.5a1.25 1.25 0 0 1 1.25 1.25A1.25 1.25 0 0 1 17.25 8A1.25 1.25 0 0 1 16 6.75a1.25 1.25 0 0 1 1.25-1.25M12 7a5 5 0 0 1 5 5a5 5 0 0 1-5 5a5 5 0 0 1-5-5a5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3z"/>
                                    </svg>
                                </div>
                                <span class="share-option-text">${artistNames[index] || `Artist ${index + 1}`}</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Create or reuse artist Instagram modal
            let artistInstagramModal = document.getElementById('artist-instagram-modal');
            if (!artistInstagramModal) {
                artistInstagramModal = document.createElement('div');
                artistInstagramModal.id = 'artist-instagram-modal';
                artistInstagramModal.className = 'share-modal';
                document.body.appendChild(artistInstagramModal);
                
                // Close modal when clicking outside
                artistInstagramModal.addEventListener('click', function(e) {
                    if (e.target === artistInstagramModal) {
                        closeArtistInstagramModal();
                    }
                });
            }
            
            artistInstagramModal.innerHTML = modalContent;
            artistInstagramModal.classList.add('show');
        }
        
        function closeArtistInstagramModal() {
            const artistInstagramModal = document.getElementById('artist-instagram-modal');
            if (artistInstagramModal) {
                artistInstagramModal.classList.remove('show');
            }
        }
        
        // Artist selection modal functionality
        function showArtistSelectionModal(artistIds, workshop) {
            const artistNames = (workshop.by || 'Artists').split(' X ');
            
            // Create modal content dynamically
            const modalContent = `
                <div class="share-content">
                    <div class="share-close" onclick="closeArtistSelectionModal()">×</div>
                    <div class="share-header">
                        <h3 class="share-title">Select Artist</h3>
                        <p class="share-subtitle">Choose which artist to view</p>
                    </div>
                    <div class="share-options" id="artist-selection-options">
                        ${artistIds.map((artistId, index) => `
                            <a href="/web/artist/${artistId}" target="_blank" rel="noopener,noreferrer" class="share-option" 
                               onclick="trackArtistClick('${artistId}', ${JSON.stringify(workshop).replace(/"/g, '&quot;')}); closeArtistSelectionModal();">
                                <div class="share-option-icon" style="background: var(--primary-gradient);">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                </div>
                                <span class="share-option-text">${artistNames[index] || `Artist ${index + 1}`}</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Create or reuse artist selection modal
            let artistSelectionModal = document.getElementById('artist-selection-modal');
            if (!artistSelectionModal) {
                artistSelectionModal = document.createElement('div');
                artistSelectionModal.id = 'artist-selection-modal';
                artistSelectionModal.className = 'share-modal';
                document.body.appendChild(artistSelectionModal);
                
                // Close modal when clicking outside
                artistSelectionModal.addEventListener('click', function(e) {
                    if (e.target === artistSelectionModal) {
                        closeArtistSelectionModal();
                    }
                });
            }
            
            artistSelectionModal.innerHTML = modalContent;
            artistSelectionModal.classList.add('show');
        }
        
        function closeArtistSelectionModal() {
            const artistSelectionModal = document.getElementById('artist-selection-modal');
            if (artistSelectionModal) {
                artistSelectionModal.classList.remove('show');
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copied to clipboard!');
            });
        }

        // Authentication Functions
        function handleAuth() {
            if (currentUser) {
                // Show profile modal
                openProfileModal();
            } else {
                // Show login modal
                openLoginModal();
            }
        }

        function openLoginModal() {
            loginModal.classList.add('show');
            mobileInput.focus();
            hideAuthErrors();
        }

        function closeLoginModal() {
            loginModal.classList.remove('show');
            document.getElementById('login-form').reset();
            hideAuthErrors();
        }

        function openOTPModal() {
            loginModal.classList.remove('show');
            otpModal.classList.add('show');
            otpMobileNumber.textContent = currentMobileNumber;
            setupOTPInputs();
            startResendTimer();
        }

        function closeOTPModal() {
            otpModal.classList.remove('show');
            clearResendTimer();
            hideAuthErrors();
            // Reset OTP inputs
            otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('valid');
            });
        }

        function openProfileModal() {
            if (!currentUser) return;

            // Populate profile data
            populateProfileModal();

            // Show modal
            profileModal.classList.add('show');
        }

        function closeProfileModal() {
            profileModal.classList.remove('show');
        }

        function populateProfileModal() {
            if (!currentUser) return;

            // Set profile name
            profileName.textContent = currentUser.name || 'Dance Enthusiast';

            // Set mobile number
            profileMobile.textContent = '+91 ' + currentUser.mobile_number;

            // Set profile status
            const statusBadge = profileStatus.querySelector('.status-badge');
            if (currentUser.profile_complete) {
                statusBadge.textContent = 'Profile Complete';
                statusBadge.className = 'status-badge complete';
            } else {
                statusBadge.textContent = 'Complete Profile';
                statusBadge.className = 'status-badge incomplete';
            }

            // Set profile avatar
            profileAvatarContainer.innerHTML = '';

            if (currentUser.profile_picture_url) {
                const avatar = document.createElement('img');
                avatar.className = 'profile-avatar-large';

                // Use centralized image loading function
                loadImage({
                    element: avatar,
                    type: 'user',
                    entityId: currentUser.user_id,
                    altText: currentUser.name || 'Profile',
                    onSuccess: function(img) {
                        profileAvatarContainer.appendChild(img);
                    },
                    onError: function(img) {
                        showProfileFallbackLarge();
                    }
                });
            } else {
                showProfileFallbackLarge();
            }
        }

        function showProfileFallbackLarge() {
            const fallback = document.createElement('div');
            fallback.className = 'profile-fallback-large';
            fallback.textContent = getInitials(currentUser.name || currentUser.mobile_number);
            profileAvatarContainer.appendChild(fallback);
        }

        function navigateToEditProfile() {
            closeProfileModal();
            // For web, redirect to profile setup page
            window.location.href = '/profile-setup';
        }

        function openOrdersModal() {
            if (!currentUser) return;

            closeProfileModal();

            // Load orders data
            if (!ordersData) {
                loadOrdersData();
            }

            // Show orders modal
            const ordersModal = document.getElementById('orders-modal');
            ordersModal.classList.add('show');
        }

        function openRewardsModal() {
            if (!currentUser) return;

            closeProfileModal();

            // Load rewards data
            if (!rewardsData) {
                loadRewardsData();
            }

            // Show rewards modal
            const rewardsModal = document.getElementById('rewards-modal');
            rewardsModal.classList.add('show');
        }

        function closeOrdersModal() {
            const ordersModal = document.getElementById('orders-modal');
            ordersModal.classList.remove('show');
        }

        function closeRewardsModal() {
            const rewardsModal = document.getElementById('rewards-modal');
            rewardsModal.classList.remove('show');
        }

        // Orders functionality
        async function loadOrdersData() {
            if (!authToken) return;

            const ordersLoading = document.getElementById('orders-loading');
            const ordersError = document.getElementById('orders-error');
            const ordersList = document.getElementById('orders-list');

            ordersLoading.style.display = 'flex';
            ordersError.style.display = 'none';
            ordersList.innerHTML = '';

            try {
                const response = await fetch('/api/orders/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }

                ordersData = await response.json();
                console.log('Orders API Response:', ordersData);
                console.log('First order sample:', ordersData.orders ? ordersData.orders[0] : 'No orders');
                displayOrders(ordersData.orders);

            } catch (error) {
                console.error('Error loading orders:', error);
                ordersLoading.style.display = 'none';
                ordersError.style.display = 'block';
                ordersError.querySelector('p').textContent = error.message || 'Failed to load orders. Please try again.';
            } finally {
                ordersLoading.style.display = 'none';
            }
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('orders-list');
            const ordersEmpty = document.getElementById('orders-empty');

            if (!orders || orders.length === 0) {
                ordersEmpty.style.display = 'block';
                return;
            }

            ordersEmpty.style.display = 'none';
            ordersList.innerHTML = '';

            orders.forEach(order => {
                const orderCard = createOrderCard(order);
                ordersList.appendChild(orderCard);
            });
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';

            const statusClass = order.status.toLowerCase();
            const statusText = getOrderStatusText(order.status);

            // Calculate amounts - handle both paise (new) and rupees (old) formats
            // If amount is small (≤ 10000), treat as rupees; otherwise treat as paise
            const isAmountInRupees = order.amount <= 10000;
            const originalAmount = isAmountInRupees ? order.amount : (order.amount / 100);
            const rewardsUsed = order.rewards_redeemed || 0;
            const cashbackEarned = order.cashback_amount || 0;
            const finalAmount = originalAmount - rewardsUsed;

            // Determine action button state with improved logic
            let actionButtonHtml = '';

            // For pending orders (created status), show Pay button if payment link exists
            if (order.status === 'created' && order.payment_link_url) {
                actionButtonHtml = `
                    <button class="pay-btn" onclick="payOrder('${order.order_id}', '${order.payment_link_url}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                            <circle cx="8" cy="10" r="2"/>
                            <path d="M8 12v4"/>
                            <path d="M16 12v4"/>
                        </svg>
                        <span>Pay Now</span>
                    </button>
                `;
            } else if (order.status === 'paid') {
                // First check for generating status
                if (order.qr_status === 'generating') {
                    actionButtonHtml = `
                        <button class="qr-generate-btn qr-generating" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <rect x="7" y="7" width="10" height="10"/>
                                <circle cx="9" cy="9" r="1"/>
                                <circle cx="15" cy="9" r="1"/>
                                <circle cx="15" cy="15" r="1"/>
                                <path d="M9 15h6"/>
                            </svg>
                            <span>Generating QR...</span>
                        </button>
                    `;
                } else {
                    // For completed orders, check if QR code data is available in the order
                    const orderId = order.order_id;
                    if (order.qr_codes_data || order.qr_available || order.has_qr_code) {
                        // QR code data is available - show "View QR Code"
                        const qrCount = order.qr_codes_data ? Object.keys(order.qr_codes_data).length : 1;
                        const qrText = qrCount > 1 ? `View ${qrCount} QR Codes` : 'View QR Code';
                        actionButtonHtml = `
                            <button class="qr-view-btn" onclick="viewQRCode('${orderId}', '${order.workshop_details.title}', '${order.workshop_details.artist_names.join(', ')}', ${JSON.stringify(order).replace(/"/g, '&quot;')})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <rect x="7" y="7" width="10" height="10"/>
                                    <circle cx="9" cy="9" r="1"/>
                                    <circle cx="15" cy="9" r="1"/>
                                    <circle cx="15" cy="15" r="1"/>
                                    <path d="M9 15h6"/>
                                </svg>
                                <span>${qrText}</span>
                            </button>
                        `;
                    } else {
                        // No QR code data available - show "QR code generation in progress"
                        actionButtonHtml = `
                            <button class="qr-generate-btn qr-generating" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <rect x="7" y="7" width="10" height="10"/>
                                    <circle cx="9" cy="9" r="1"/>
                                    <circle cx="15" cy="9" r="1"/>
                                    <circle cx="15" cy="15" r="1"/>
                                    <path d="M9 15h6"/>
                                </svg>
                                <span>QR code generation in progress</span>
                            </button>
                        `;
                    }
                }
            }

            card.innerHTML = `
                <div class="order-header">
                    <div>
                        <div class="order-title">${order.workshop_details.title} ${order.is_bundle_order ? '<span class="bundle-badge">Bundle</span>' : ''}</div>
                        <div class="order-artists">${order.workshop_details.artist_names.join(', ')}</div>
                    </div>
                    <div class="order-status ${statusClass}">${statusText}</div>
                </div>

                ${actionButtonHtml ? `
                    <div class="order-action-top">
                        ${actionButtonHtml}
                    </div>
                ` : ''}

                ${order.is_bundle_order && order.bundle_info ? `
                <div class="bundle-info">
                    <div class="bundle-info-title">Bundle: ${order.bundle_info.name}</div>
                    <div class="bundle-info-text">${order.bundle_info.description}</div>
                    <div class="bundle-info-text">${order.bundle_total_workshops} workshops included</div>
                    ${order.bundle_info.savings_amount > 0 ? `<div class="bundle-savings">You saved ₹${order.bundle_info.savings_amount.toFixed(2)}!</div>` : ''}
                    ${order.bundle_info.workshops && order.bundle_info.workshops.length > 0 ? `
                    <div class="bundle-workshops">
                        <div class="bundle-workshops-title">Workshops in this bundle:</div>
                        ${order.bundle_info.workshops.map(workshop => `
                            <div class="bundle-workshop-item">
                                <div class="bundle-workshop-name">${workshop.song || workshop.title || 'Workshop'}</div>
                                <div class="bundle-workshop-artists">${workshop.artist_names ? workshop.artist_names.join(', ') : (workshop.by || 'TBD')}</div>
                                <div class="bundle-workshop-details">${workshop.studio_name || 'TBD'} • ${workshop.date || 'TBD'} • ${workshop.time || 'TBD'}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
                ` : order.is_bundle_order ? `
                <div class="bundle-info">
                    <div class="bundle-info-title">Part of Bundle</div>
                    <div class="bundle-info-text">${order.bundle_total_workshops} workshops included</div>
                    <div class="bundle-info-text">Bundle: ${order.bundle_id || 'Loading...'}</div>
                </div>
                ` : ''}
                <div class="order-details">
                    <div class="order-detail">
                        <span class="order-label">Studio:</span>
                        <span class="order-value">${order.workshop_details.studio_name}</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">Date:</span>
                        <span class="order-value">${order.workshop_details.date}</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">Time:</span>
                        <span class="order-value">${order.workshop_details.time}</span>
                    </div>
                    <div class="order-detail">
                        <span class="order-label">Amount:</span>
                        <span class="order-value order-amount">₹${originalAmount.toFixed(2)}</span>
                    </div>
                    ${rewardsUsed > 0 ? `
                        <div class="order-detail">
                            <span class="order-label">Original Amount:</span>
                            <span class="order-value">₹${originalAmount.toFixed(2)}</span>
                        </div>
                    ` : ''}
                </div>
                ${rewardsUsed > 0 || cashbackEarned > 0 ? `
                    <div class="order-rewards">
                        ${rewardsUsed > 0 ? `
                            <div class="order-reward-item">
                                <span class="order-reward-label">Rewards Redeemed:</span>
                                <span class="order-reward-value rewards-used">₹${rewardsUsed.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        ${cashbackEarned > 0 ? `
                            <div class="order-reward-item">
                                <span class="order-reward-label">Cashback Earned:</span>
                                <span class="order-reward-value cashback-earned">₹${cashbackEarned.toFixed(2)}</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;

            return card;
        }

        // Duplicate function - keeping original layout
        // function createWorkshopCard(workshop) {
        //     // This function was replaced to keep original workshop card layout
        // }

        // Keeping original layout - these functions are not used
        // function getRegistrationButtonText(type) { ... }
        // function getRegistrationButtonClass(type) { ... }
        // function getRegistrationButtonIcon(type) { ... }

        // Original registration functions - keeping original layout
        // New registration handler functions are not used with original layout

        function getOrderStatusText(status) {
            switch (status) {
                case 'created': return 'Pending';
                case 'paid': return 'Completed';
                case 'failed': return 'Failed';
                case 'expired': return 'Expired';
                case 'cancelled': return 'Cancelled';
                default: return status;
            }
        }

        function applyOrderFilter(filter) {
            currentOrderFilter = filter;

            // Update filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });

            const activeChip = document.querySelector(`.filter-chip[onclick*="${filter}"]`);
            if (activeChip) {
                activeChip.classList.add('active');
            }

            // Filter orders
            if (ordersData && ordersData.orders) {
                let filteredOrders = ordersData.orders;

                switch (filter) {
                    case 'pending':
                        filteredOrders = ordersData.orders.filter(order => order.status === 'created');
                        break;
                    case 'completed':
                        filteredOrders = ordersData.orders.filter(order => order.status === 'paid');
                        break;
                    case 'failed':
                        filteredOrders = ordersData.orders.filter(order => ['failed', 'expired'].includes(order.status));
                        break;
                }

                displayOrders(filteredOrders);
            }
        }

        function refreshOrders() {
            ordersData = null;
            loadOrdersData();
        }

        // Rewards functionality
        async function loadRewardsData() {
            if (!authToken) return;

            const rewardsLoading = document.getElementById('rewards-loading');
            const rewardsError = document.getElementById('rewards-error');

            rewardsLoading.style.display = 'flex';
            rewardsError.style.display = 'none';

            try {
                // Load both balance and transactions
                const [balanceResponse, transactionsResponse] = await Promise.all([
                    fetch('/api/rewards/balance', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                        }
                    }),
                    fetch('/api/rewards/transactions?page=1&page_size=20', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                        }
                    })
                ]);

                if (!balanceResponse.ok || !transactionsResponse.ok) {
                    throw new Error('Failed to load rewards data');
                }

                const balanceData = await balanceResponse.json();
                const transactionsData = await transactionsResponse.json();

                rewardsData = {
                    balance: balanceData,
                    transactions: transactionsData.transactions,
                    hasMore: transactionsData.transactions.length >= 20
                };

                displayRewardsData();

            } catch (error) {
                console.error('Error loading rewards:', error);
                rewardsLoading.style.display = 'none';
                rewardsError.style.display = 'block';
                rewardsError.querySelector('p').textContent = error.message || 'Failed to load rewards. Please try again.';
            } finally {
                rewardsLoading.style.display = 'none';
            }
        }

        function displayRewardsData() {
            if (!rewardsData) return;

            const rewardsBalance = document.getElementById('rewards-balance');
            const transactionsList = document.getElementById('transactions-list');

            // Display balance
            document.getElementById('available-balance').textContent = `₹${rewardsData.balance.available_balance}`;
            document.getElementById('earned-amount').textContent = `₹${rewardsData.balance.lifetime_earned}`;
            document.getElementById('redeemed-amount').textContent = `₹${rewardsData.balance.lifetime_redeemed}`;

            rewardsBalance.style.display = 'block';

            // Display transactions
            displayTransactions(rewardsData.transactions);
        }

        function displayTransactions(transactions) {
            const transactionsList = document.getElementById('transactions-list');
            const loadMoreBtn = document.getElementById('load-more-btn');

            if (!transactions || transactions.length === 0) {
                transactionsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No transactions found</div>';
                loadMoreBtn.style.display = 'none';
                return;
            }

            // Filter transactions based on current filter
            let filteredTransactions = transactions;
            if (currentTransactionFilter === 'credit') {
                filteredTransactions = transactions.filter(t => t.transaction_type === 'credit');
            } else if (currentTransactionFilter === 'debit') {
                filteredTransactions = transactions.filter(t => t.transaction_type === 'debit');
            }

            transactionsList.innerHTML = '';

            filteredTransactions.forEach(transaction => {
                const transactionItem = createTransactionItem(transaction);
                transactionsList.appendChild(transactionItem);
            });

            // Show/hide load more button
            loadMoreBtn.style.display = hasMoreTransactions ? 'block' : 'none';
        }

        function createTransactionItem(transaction) {
            const item = document.createElement('div');
            item.className = 'transaction-item';

            const typeClass = transaction.transaction_type === 'credit' ? 'credit' : 'debit';
            const amountClass = transaction.transaction_type === 'credit' ? 'credit' : 'debit';
            const sign = transaction.transaction_type === 'credit' ? '+' : '-';

            item.innerHTML = `
                <div class="transaction-icon ${typeClass}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${transaction.transaction_type === 'credit'
                            ? '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>'
                            : '<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M12 2l3 3-3 3-3-3 3-3z"/><path d="M12 22l3-3-3-3-3 3 3 3z"/>'
                        }
                    </svg>
                </div>
                <div class="transaction-info">
                    <div class="transaction-title">${transaction.description}</div>
                    <div class="transaction-desc">${formatTransactionDate(transaction.created_at)}</div>
                </div>
                <div class="transaction-amount ${amountClass}">${sign}₹${transaction.amount}</div>
            `;

            return item;
        }

        function formatTransactionDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function switchTransactionTab(filter) {
            currentTransactionFilter = filter;

            // Update tab buttons
            document.querySelectorAll('.transaction-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const activeTab = document.querySelector(`.transaction-tab[onclick*="${filter}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Filter transactions
            if (rewardsData && rewardsData.transactions) {
                displayTransactions(rewardsData.transactions);
            }
        }

        async function loadMoreTransactions() {
            if (!authToken || !hasMoreTransactions) return;

            try {
                transactionsPage++;
                const response = await fetch(`/api/rewards/transactions?page=${transactionsPage}&page_size=20`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load more transactions');
                }

                const data = await response.json();
                rewardsData.transactions.push(...data.transactions);
                hasMoreTransactions = data.transactions.length >= 20;

                displayTransactions(rewardsData.transactions);

            } catch (error) {
                console.error('Error loading more transactions:', error);
            }
        }

        function refreshRewards() {
            rewardsData = null;
            loadRewardsData();
        }

        // QR Code functionality
        async function generateQRCode(orderId, workshopTitle, workshopArtists) {
            if (!authToken) return;

            // First check if QR code already exists in the order data
            let qrCodesData = null;
            if (ordersData && ordersData.orders) {
                const order = ordersData.orders.find(o => (o.id && o.id === orderId) || (o.order_id && o.order_id === orderId));
                if (order && order.qr_codes_data) {
                    console.log('QR Code: Already exists in order data, using existing');
                    qrCodesData = order.qr_codes_data;
                }
            }

            const qrModal = document.getElementById('qr-modal');
            const qrLoading = document.getElementById('qr-loading');
            const qrError = document.getElementById('qr-error');
            const qrContainer = document.getElementById('qr-code-container');

            // Show modal and loading
            qrModal.classList.add('show');
            document.body.classList.add('modal-open');
            qrLoading.style.display = 'flex';
            qrError.style.display = 'none';
            qrContainer.style.display = 'none';

            // Set workshop info
            const titleElement = document.getElementById('qr-workshop-title');
            const detailsElement = document.getElementById('qr-workshop-details');

            if (titleElement) {
                titleElement.textContent = workshopTitle;
            } else {
                console.error('QR Workshop title element not found');
            }

            if (detailsElement) {
                detailsElement.textContent = workshopArtists;
            } else {
                console.error('QR Workshop details element not found');
            }

            try {
                if (qrCodeData) {
                    // Use existing QR code data
                    console.log('QR Code: Using existing data from order');
                    await displayQRCode(qrCodeData, workshopTitle, workshopArtists);
                } else {
                    // Generate new QR code
                    console.log('QR Code: Generating new QR code');
                    const response = await fetch(`/api/orders/${orderId}/generate-qr`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate QR code');
                    }

                    const qrData = await response.json();

                    // Display the newly generated QR code
                    if (qrData.qr_codes_data) {
                        // Handle multiple QR codes (bundle)
                        const order = { qr_codes_data: qrData.qr_codes_data };
                        await displayMultipleQRCodes(order, {}); // Pass empty object as fallback
                    } else if (qrData.qr_codes_data && Object.keys(qrData.qr_codes_data).length === 1) {
                        // Handle single QR code
                        const qrCodeData = Object.values(qrData.qr_codes_data)[0];
                        await displayQRCode(qrCodeData, workshopTitle, workshopArtists);
                    }

                    // Update the order data with the new QR codes
                    if (ordersData && ordersData.orders) {
                        const orderIndex = ordersData.orders.findIndex(o => (o.id && o.id === orderId) || (o.order_id && o.order_id === orderId));
                        if (orderIndex !== -1) {
                            ordersData.orders[orderIndex].qr_codes_data = qrData.qr_codes_data;
                            console.log('QR Code: Updated order data with new QR codes');
                        }
                    }
                }

            } catch (error) {
                console.error('Error generating QR code:', error);
                qrLoading.style.display = 'none';
                qrError.style.display = 'block';
                qrError.querySelector('p').textContent = error.message || 'Failed to generate QR code. Please try again.';
                document.body.classList.remove('modal-open');
            }
        }

        async function viewQRCode(orderId, workshopTitle, workshopArtists, orderData = null) {
            if (!authToken) return;

            console.log('ViewQRCode called with orderId:', orderId);

            // Find the order data
            let order = orderData;
            if (!order && ordersData && ordersData.orders) {
                order = ordersData.orders.find(o => (o.id && o.id === orderId) || (o.order_id && o.order_id === orderId));
            }

            if (!order) {
                console.error('Order not found:', orderId);
                alert('Order data not available. Please refresh the page and try again.');
                return;
            }

            // Check if we have multiple QR codes (bundle) or single QR code
            const hasMultipleQRCodes = order.qr_codes_data && Object.keys(order.qr_codes_data).length > 1;
            const hasSingleQRCode = order.qr_codes_data && Object.keys(order.qr_codes_data).length === 1;

            if (!hasMultipleQRCodes && !hasSingleQRCode) {
                console.error('No QR code data available for order:', orderId);
                alert('QR code data not available. Please refresh the page and try again.');
                return;
            }

            // Get workshop titles from workshop_details_map if available
            let workshopTitles = {};
            if (order.workshop_details_map) {
                Object.entries(order.workshop_details_map).forEach(([uuid, details]) => {
                    workshopTitles[uuid] = details.song || details.title || 'Workshop';
                });
                console.log('Using workshop details map for titles:', workshopTitles);
            } else if (hasMultipleQRCodes && order.bundle_info && order.bundle_info.workshops) {
                // Fallback to bundle info
                order.bundle_info.workshops.forEach(workshop => {
                    workshopTitles[workshop.uuid] = workshop.song || workshop.title || 'Workshop';
                });
                console.log('Using bundle info for titles:', workshopTitles);
            }

            const qrModal = document.getElementById('qr-modal');
            const qrLoading = document.getElementById('qr-loading');
            const qrError = document.getElementById('qr-error');
            const qrContainer = document.getElementById('qr-code-container');

            // Show modal and loading
            qrModal.classList.add('show');
            document.body.classList.add('modal-open');
            qrLoading.style.display = 'flex';
            qrError.style.display = 'none';
            qrContainer.style.display = 'none';

            try {
                if (hasMultipleQRCodes) {
                    // Display multiple QR codes for bundle
                    console.log('QR Code: Displaying multiple QR codes for bundle');
                    await displayMultipleQRCodes(order, workshopTitles);
                } else {
                    // Display single QR code
                    console.log('QR Code: Displaying single QR code');
                    const qrCodeData = Object.values(order.qr_codes_data)[0];
                    const workshopUuid = Object.keys(order.qr_codes_data)[0];
                    const enhancedTitle = workshopTitles[workshopUuid] || workshopTitle;
                    console.log('QR Code: Using enhanced title for single QR:', enhancedTitle);
                    await displayQRCode(qrCodeData, enhancedTitle, workshopArtists);
                }

            } catch (error) {
                console.error('Error displaying QR code:', error);
                qrLoading.style.display = 'none';
                qrError.style.display = 'block';
                qrError.querySelector('p').textContent = error.message || 'Failed to display QR code. Please try again.';
                document.body.classList.remove('modal-open');
            }
        }

        async function displayQRCode(qrCodeData, workshopTitle, workshopArtists) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrLoading = document.getElementById('qr-loading');
            const qrError = document.getElementById('qr-error');

            // Hide loading, show container
            qrLoading.style.display = 'none';
            qrError.style.display = 'none';
            qrContainer.style.display = 'flex';

            try {
                const qrDisplay = document.getElementById('qr-code-display');
                qrDisplay.innerHTML = '';

                // Debug: Log the QR code data format
                console.log('QR Code Data received:', qrCodeData);
                console.log('QR Code Data type:', typeof qrCodeData);
                console.log('QR Code Data length:', qrCodeData ? qrCodeData.length : 'null');

                // Extract base64 data from data URL (similar to Flutter app)
                let base64String;

                if (qrCodeData.startsWith && qrCodeData.startsWith('data:image/png;base64,')) {
                    base64String = qrCodeData.substring('data:image/png;base64,'.length);
                    console.log('QR Code: PNG base64 format detected');
                } else if (qrCodeData.startsWith && qrCodeData.startsWith('data:image/')) {
                    // Handle other image formats
                    const commaIndex = qrCodeData.indexOf(',');
                    base64String = qrCodeData.substring(commaIndex + 1);
                    console.log('QR Code: Other image format detected');
                } else if (qrCodeData.startsWith && (qrCodeData.startsWith('http') || qrCodeData.startsWith('/'))) {
                    // Handle URL format - create image directly from URL
                    console.log('QR Code: URL format detected, using directly');
                    const img = document.createElement('img');
                    img.src = qrCodeData;
                    img.style.width = '200px';
                    img.style.height = '200px';
                    img.style.objectFit = 'contain';
                    img.style.borderRadius = '8px';
                    img.style.backgroundColor = 'white';
                    img.style.padding = '8px';
                    img.style.boxShadow = '0 4px 12px rgba(0, 212, 255, 0.3)';

                    img.onerror = function() {
                        qrContainer.style.display = 'none';
                        qrError.style.display = 'block';
                        qrError.querySelector('p').textContent = 'Failed to load QR code image. Please try again.';
                    };

                    qrDisplay.appendChild(img);

                    // Store QR data for download/share
                    qrDisplay.setAttribute('data-qr-data', qrCodeData);
                    qrDisplay.setAttribute('data-workshop-title', workshopTitle);
                    return; // Exit early for URL format
                } else {
                    // Assume it's already base64
                    base64String = qrCodeData;
                    console.log('QR Code: Assuming base64 format');
                }

                // Convert base64 to blob and create image
                let byteCharacters;
                try {
                    byteCharacters = atob(base64String);
                    console.log('QR Code: Successfully decoded base64');
                } catch (decodeError) {
                    console.error('QR Code: Failed to decode base64:', decodeError);
                    throw new Error('Invalid base64 QR code data');
                }

                const byteNumbers = new Array(byteCharacters.length);

                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }

                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/png' });

                // Create image element to display the QR code
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                img.style.width = '200px';
                img.style.height = '200px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '8px';
                img.style.backgroundColor = 'white';
                img.style.padding = '8px';
                img.style.boxShadow = '0 4px 12px rgba(0, 212, 255, 0.3)';

                // Add error handling for image loading
                img.onerror = function() {
                    qrContainer.style.display = 'none';
                    qrError.style.display = 'block';
                    qrError.querySelector('p').textContent = 'Failed to load QR code image. Please try again.';
                };

                qrDisplay.appendChild(img);

                // Store QR data for download/share
                qrDisplay.setAttribute('data-qr-data', qrCodeData);
                qrDisplay.setAttribute('data-workshop-title', workshopTitle);

            } catch (error) {
                console.error('Error displaying QR code:', error);
                qrContainer.style.display = 'none';
                qrError.style.display = 'block';
                qrError.querySelector('p').textContent = 'Failed to display QR code. Please try again.';
            }
        }

        function closeQRModal() {
            document.getElementById('qr-modal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function downloadQRCode() {
            const qrDisplay = document.getElementById('qr-code-display');
            const img = qrDisplay.querySelector('img');
            const workshopTitle = qrDisplay.getAttribute('data-workshop-title');

            if (img) {
                // Create download link
                const link = document.createElement('a');
                link.download = `${workshopTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_qr_code.png`;
                link.href = img.src;
                link.click();
            }
        }

        function shareQRCode() {
            const qrDisplay = document.getElementById('qr-code-display');
            const img = qrDisplay.querySelector('img');
            const workshopTitle = qrDisplay.getAttribute('data-workshop-title');

            if (navigator.share && navigator.canShare && img) {
                // Try to share the image file
                fetch(img.src)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `${workshopTitle}_qr_code.png`, { type: 'image/png' });
                        navigator.share({
                            title: `${workshopTitle} - QR Code`,
                            text: `Registration QR code for ${workshopTitle}`,
                            files: [file]
                        });
                    })
                    .catch(() => {
                        // Fallback to sharing just text and URL
                        navigator.share({
                            title: `${workshopTitle} - QR Code`,
                            text: `Registration QR code for ${workshopTitle}`,
                            url: window.location.href
                        });
                    });
            } else if (navigator.share) {
                // Share without image
                navigator.share({
                    title: `${workshopTitle} - QR Code`,
                    text: `Registration QR code for ${workshopTitle}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard or show message
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(`${workshopTitle} - QR Code\n${window.location.href}`)
                        .then(() => alert('QR code link copied to clipboard!'))
                        .catch(() => alert('Share feature not supported on this device'));
                } else {
                    alert('Share feature not supported on this device');
                }
            }
        }

        async function displayMultipleQRCodes(order, workshopTitles = {}) {
            const qrContainer = document.getElementById('qr-code-container');
            const qrLoading = document.getElementById('qr-loading');
            const qrError = document.getElementById('qr-error');

            // Hide loading, show container
            qrLoading.style.display = 'none';
            qrError.style.display = 'none';
            qrContainer.style.display = 'flex';

            try {
                const qrDisplay = document.getElementById('qr-code-display');
                qrDisplay.innerHTML = '';

                // Create scrollable container for multiple QR codes
                const qrScrollContainer = document.createElement('div');
                qrScrollContainer.className = 'qr-scroll-container';
                qrScrollContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                    max-height: 70vh;
                    overflow-y: auto;
                    padding: 1rem;
                    width: 100%;
                `;

                // Use workshop titles from parent function (already computed)
                // workshopTitles parameter should be passed from viewQRCode function

                // Create QR cards for each workshop
                for (const [workshopUuid, qrCodeData] of Object.entries(order.qr_codes_data)) {
                    const workshopTitle = workshopTitles[workshopUuid] || `Workshop ${Object.keys(order.qr_codes_data).indexOf(workshopUuid) + 1}`;

                    const qrCard = document.createElement('div');
                    qrCard.className = 'qr-card';
                    qrCard.style.cssText = `
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 12px;
                        padding: 1rem;
                        border: 1px solid rgba(0, 212, 255, 0.2);
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 0.75rem;
                    `;

                    // Workshop title
                    const titleElement = document.createElement('h4');
                    titleElement.textContent = workshopTitle;
                    titleElement.style.cssText = `
                        margin: 0;
                        color: #00D4FF;
                        font-size: 1rem;
                        font-weight: 600;
                        text-align: center;
                    `;

                    // QR code image
                    const qrImage = document.createElement('img');
                    qrImage.style.cssText = `
                        width: 150px;
                        height: 150px;
                        object-fit: contain;
                        border-radius: 8px;
                        background: white;
                        padding: 8px;
                        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
                    `;

                    // Extract base64 data from QR code
                    let base64String;
                    if (qrCodeData.startsWith && qrCodeData.startsWith('data:image/png;base64,')) {
                        base64String = qrCodeData.substring('data:image/png;base64,'.length);
                    } else if (qrCodeData.startsWith && qrCodeData.startsWith('data:image/')) {
                        const commaIndex = qrCodeData.indexOf(',');
                        base64String = qrCodeData.substring(commaIndex + 1);
                    } else if (qrCodeData.startsWith && (qrCodeData.startsWith('http') || qrCodeData.startsWith('/'))) {
                        // Handle URL format
                        qrImage.src = qrCodeData;
                    }

                    if (base64String) {
                        try {
                            qrImage.src = `data:image/png;base64,${base64String}`;
                            console.log('QR Code: Successfully decoded base64 for workshop:', workshopTitle);
                        } catch (decodeError) {
                            console.error('QR Code: Failed to decode base64 for workshop:', workshopTitle, decodeError);
                            qrImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlNzQ5MzkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz4KPHBhdGggZD0iTTE1IDl2NmgtNnY2Ii8+Cjwvc3ZnPgo=';
                        }
                    }

                    qrImage.onerror = function() {
                        console.error('QR Code: Failed to load image for workshop:', workshopTitle);
                        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlNzQ5MzkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiLz4KPHBhdGggZD0iTTE1IDl2NmgtNnY2Ii8+Cjwvc3ZnPgo=';
                    };

                    // Download button for this QR code
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Download QR';
                    downloadBtn.className = 'qr-download-btn';
                    downloadBtn.style.cssText = `
                        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-size: 0.875rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;
                    downloadBtn.onclick = function() {
                        const link = document.createElement('a');
                        link.download = `${workshopTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_qr_code.png`;
                        link.href = qrImage.src;
                        link.click();
                    };

                    // Assemble the card
                    qrCard.appendChild(titleElement);
                    qrCard.appendChild(qrImage);
                    qrCard.appendChild(downloadBtn);
                    qrScrollContainer.appendChild(qrCard);
                }

                qrDisplay.appendChild(qrScrollContainer);

                // Update modal title to reflect multiple QR codes
                const titleElement = document.getElementById('qr-workshop-title');
                if (titleElement) {
                    titleElement.textContent = order.bundle_info ? order.bundle_info.name : 'Workshop Bundle';
                }

                console.log('QR Code: Successfully displayed multiple QR codes');

            } catch (error) {
                console.error('Error displaying multiple QR codes:', error);
                qrContainer.style.display = 'none';
                qrError.style.display = 'block';
                qrError.querySelector('p').textContent = 'Failed to load QR codes. Please try again.';
            }
        }

        function hideAuthErrors() {
            loginError.style.display = 'none';
            otpError.style.display = 'none';
        }

        function showAuthError(errorElement, message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function setLoading(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            const btnLoader = button.querySelector('.btn-loader');

            if (isLoading) {
                btnText.style.display = 'none';
                btnLoader.style.display = 'block';
                button.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
                button.disabled = false;
            }
        }

        // OTP Input Management
        function setupOTPInputs() {
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', function(e) {
                    // Only allow numbers
                    this.value = this.value.replace(/[^0-9]/g, '');

                    // Auto focus next input
                    if (this.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }

                    // Mark as valid when filled
                    if (this.value.length === 1) {
                        this.classList.add('valid');
                    } else {
                        this.classList.remove('valid');
                    }

                    // Auto submit when all filled
                    const allFilled = Array.from(otpInputs).every(inp => inp.value.length === 1);
                    if (allFilled) {
                        handleVerifyOTP();
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text');
                    const digits = paste.replace(/[^0-9]/g, '').split('');

                    digits.forEach((digit, i) => {
                        if (index + i < otpInputs.length) {
                            otpInputs[index + i].value = digit;
                            otpInputs[index + i].classList.add('valid');
                        }
                    });

                    // Focus next empty input or last input
                    const nextIndex = Math.min(index + digits.length, otpInputs.length - 1);
                    otpInputs[nextIndex].focus();

                    // Auto submit if all filled
                    const allFilled = Array.from(otpInputs).every(inp => inp.value.length === 1);
                    if (allFilled) {
                        setTimeout(() => handleVerifyOTP(), 100);
                    }
                });
            });

            // Focus first input
            if (otpInputs.length > 0) {
                otpInputs[0].focus();
            }
        }

        function getOTPValue() {
            return Array.from(otpInputs).map(input => input.value).join('');
        }

        // Timer Management
        function startResendTimer() {
            clearResendTimer();
            resendCountdown = 30;

            otpTimer = setInterval(() => {
                resendCountdown--;
                updateResendButton();

                if (resendCountdown <= 0) {
                    clearResendTimer();
                }
            }, 1000);
        }

        function clearResendTimer() {
            if (otpTimer) {
                clearInterval(otpTimer);
                otpTimer = null;
            }
            resendCountdown = 30;
            updateResendButton();
        }

        function updateResendButton() {
            const countdownText = resendOtpBtn.querySelector('.countdown-text');
            const resendText = resendOtpBtn.querySelector('.resend-text');

            if (resendCountdown > 0) {
                resendOtpBtn.disabled = true;
                countdownText.textContent = `Resend in ${resendCountdown}s`;
            } else {
                resendOtpBtn.disabled = false;
            }
        }

        // API Calls
        async function sendOTP(mobileNumber) {
            try {
                const response = await fetch('/api/auth/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mobile_number: mobileNumber
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to send OTP');
                }

                return data.message || 'OTP sent successfully';
            } catch (error) {
                console.error('Send OTP error:', error);
                throw error;
            }
        }

        async function verifyOTP(mobileNumber, otp) {
            try {
                const response = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mobile_number: mobileNumber,
                        otp: otp
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'OTP verification failed');
                }

                return data;
            } catch (error) {
                console.error('Verify OTP error:', error);
                throw error;
            }
        }

        async function getUserProfile(token) {
            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error('Failed to fetch user profile');
                }

                return data;
            } catch (error) {
                console.error('Get profile error:', error);
                throw error;
            }
        }

        // Form Handlers
        async function handleSendOTP(event) {
            event.preventDefault();

            const mobileNumber = mobileInput.value.trim();

            if (!mobileNumber || mobileNumber.length !== 10) {
                showAuthError(loginError, 'Please enter a valid 10-digit mobile number');
                return;
            }

            setLoading(sendOtpBtn, true);
            hideAuthErrors();

            try {
                await sendOTP(mobileNumber);
                currentMobileNumber = mobileNumber;
                openOTPModal();
            } catch (error) {
                showAuthError(loginError, error.message || 'Failed to send OTP. Please try again.');
            } finally {
                setLoading(sendOtpBtn, false);
            }
        }

        async function handleVerifyOTP(event) {
            if (event) event.preventDefault();

            const otp = getOTPValue();

            if (otp.length !== 6) {
                showAuthError(otpError, 'Please enter the complete 6-digit OTP');
                return;
            }

            setLoading(verifyOtpBtn, true);
            hideAuthErrors();

            try {
                const result = await verifyOTP(currentMobileNumber, otp);
                authToken = result.access_token;

                // Get user profile
                const userProfile = await getUserProfile(authToken);
                currentUser = userProfile;

                // Save to localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // Update UI
                updateAuthUI();
                closeOTPModal();

                // Show success message
                alert('Login successful! Welcome to Nachna.');

            } catch (error) {
                showAuthError(otpError, error.message || 'Invalid OTP. Please try again.');
            } finally {
                setLoading(verifyOtpBtn, false);
            }
        }

        function resendOTP() {
            if (resendCountdown > 0) return;

            handleSendOTP({ preventDefault: () => {} });
        }

        function logout() {
            // Clear local storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');

            // Clear variables
            authToken = null;
            currentUser = null;

            // Update UI
            updateAuthUI();

            // Hide profile modal
            closeProfileModal();

            // Show logout message
            alert('You have been logged out successfully.');
        }

        // UI Updates
        function updateAuthUI() {
            const authText = authButton.querySelector('.auth-text');

            if (currentUser) {
                // Show profile avatar
                authButton.innerHTML = '';

                if (currentUser.profile_picture_url) {
                    const avatar = document.createElement('img');
                    avatar.className = 'profile-avatar';
                    avatar.alt = currentUser.name || 'Profile';

                    // Use centralized image loading function
                    loadImage({
                        element: avatar,
                        type: 'user',
                        entityId: currentUser.user_id,
                        altText: currentUser.name || 'Profile',
                        onSuccess: function(img) {
                            authButton.appendChild(img);
                        },
                        onError: function(img) {
                            showProfileFallback();
                        }
                    });
                } else {
                    showProfileFallback();
                }

                // Add click handler for profile dropdown
                authButton.onclick = function() {
                    handleAuth();
                };

            } else {
                // Show login button
                authButton.innerHTML = `
                    <span class="auth-text">Login</span>
                    <svg class="auth-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                `;

                // Add click handler for login
                authButton.onclick = function() {
                    handleAuth();
                };
            }
        }

        function showProfileFallback() {
            const fallback = document.createElement('div');
            fallback.className = 'profile-fallback';
            fallback.textContent = getInitials(currentUser.name || currentUser.mobile_number);
            authButton.appendChild(fallback);
        }

        // Initialization
        function initializeAuth() {
            // Check for existing session
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');

            if (savedToken && savedUser) {
                try {
                    authToken = savedToken;
                    currentUser = JSON.parse(savedUser);
                    updateAuthUI();
                } catch (error) {
                    console.error('Error restoring auth session:', error);
                    logout();
                }
            }

            // Set up event listeners
            setupAuthEventListeners();
        }

        function setupAuthEventListeners() {
            // Close modals when clicking outside
            loginModal.addEventListener('click', function(e) {
                if (e.target === loginModal) {
                    closeLoginModal();
                }
            });

            otpModal.addEventListener('click', function(e) {
                if (e.target === otpModal) {
                    closeOTPModal();
                }
            });

            profileModal.addEventListener('click', function(e) {
                if (e.target === profileModal) {
                    closeProfileModal();
                }
            });

            // Close modals when clicking outside auth container (for profile modal)
            document.addEventListener('click', function(e) {
                if (!authContainer.contains(e.target) && !profileModal.contains(e.target)) {
                    closeProfileModal();
                }
            });

            // Close bundle suggestion modal when clicking outside
            document.addEventListener('click', function(e) {
                const bundleModal = document.getElementById('bundle-suggestion-modal');
                if (bundleModal && e.target === bundleModal) {
                    closeBundleSuggestionModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (loginModal.classList.contains('show')) {
                        closeLoginModal();
                    } else if (otpModal.classList.contains('show')) {
                        closeOTPModal();
                    } else if (profileModal.classList.contains('show')) {
                        closeProfileModal();
                    } else {
                        const bundleModal = document.getElementById('bundle-suggestion-modal');
                        if (bundleModal && bundleModal.style.display === 'flex') {
                            closeBundleSuggestionModal();
                        }
                    }
                }
            });
        }
        
        // Main load function
        async function loadData() {
            showLoading();
            errorState.style.display = 'none';

            try {
                // Initialize authentication first
                initializeAuth();

                // Load both in parallel
                const results = await Promise.allSettled([
                    loadStudioData(),
                    loadWorkshopsData()
                ]);

                // Check if studio data loaded successfully
                if (results[0].status === 'rejected') {
                    throw new Error('Failed to load studio data: ' + results[0].reason);
                }

                // Workshop data failure is less critical
                if (results[1].status === 'rejected') {
                    // Workshop load failed - continue with studio info only
                }

            } catch (error) {
                showError(error.message || 'Failed to load studio data. Please try again.');
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
        
        // Close modal when clicking outside
        shareModal.addEventListener('click', function(e) {
            if (e.target === shareModal) {
                closeShareModal();
            }
        });

        // Close orders, rewards, and QR modals when clicking outside
        const ordersModal = document.getElementById('orders-modal');
        const rewardsModal = document.getElementById('rewards-modal');
        const qrModal = document.getElementById('qr-modal');

        if (ordersModal) {
            ordersModal.addEventListener('click', function(e) {
                if (e.target === ordersModal) {
                    closeOrdersModal();
                }
            });
        }

        if (rewardsModal) {
            rewardsModal.addEventListener('click', function(e) {
                if (e.target === rewardsModal) {
                    closeRewardsModal();
                }
            });
        }

        if (qrModal) {
            qrModal.addEventListener('click', function(e) {
                if (e.target === qrModal) {
                    closeQRModal();
                }
            });
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                const now = new Date().getTime();
                const lastLoad = parseInt(localStorage.getItem('lastStudioLoad') || '0');
                if (now - lastLoad > 5 * 60 * 1000) { // 5 minutes
                    loadData();
                    localStorage.setItem('lastStudioLoad', now.toString());
                }
            }
        });
        
        // Set initial load timestamp
        localStorage.setItem('lastStudioLoad', new Date().getTime().toString());
        
        
        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (shareModal.classList.contains('show')) {
                    closeShareModal();
                }
                const artistInstagramModal = document.getElementById('artist-instagram-modal');
                if (artistInstagramModal && artistInstagramModal.classList.contains('show')) {
                    closeArtistInstagramModal();
                }
                const artistSelectionModal = document.getElementById('artist-selection-modal');
                if (artistSelectionModal && artistSelectionModal.classList.contains('show')) {
                    closeArtistSelectionModal();
                }
                if (ordersModal && ordersModal.classList.contains('show')) {
                    closeOrdersModal();
                }
                if (rewardsModal && rewardsModal.classList.contains('show')) {
                    closeRewardsModal();
                }
                if (qrModal && qrModal.classList.contains('show')) {
                    closeQRModal();
                }
            }
        });
    </script>
</body>
</html>